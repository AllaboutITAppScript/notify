<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        /* [Keep all existing styles] */
    </style>
</head>
<body class="min-h-screen">
    <!-- [Keep all HTML structure] -->
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <script>
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ GOOGLE_SCRIPT_URL ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwpOYJ_pB6Llu9bd7RJABMd0awxu09oVFPB1cK4zsq3-aBYze5EpSHTSGgO1EcSJ3DwpQ/exec";
        
        // DOM Elements
        const alarmForm = document.getElementById('alarmForm');
        const dateInput = document.getElementById('date');
        const timeInput = document.getElementById('time');
        const titleInput = document.getElementById('title');
        const descriptionInput = document.getElementById('description');
        const currentTimeElement = document.getElementById('currentTime');
        const currentDateElement = document.getElementById('currentDate');
        const activeAlarms = document.getElementById('activeAlarms');
        const totalAlarmsElement = document.getElementById('totalAlarms');
        const nextAlarmTimeElement = document.getElementById('nextAlarmTime');
        const syncCountElement = document.getElementById('syncCount');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const clearBtn = document.getElementById('clearBtn');
        const demoNotification = document.getElementById('demoNotification');
        const demoTitle = document.getElementById('demoTitle');
        const demoDesc = document.getElementById('demoDesc');
        const demoTime = document.getElementById('demoTime');
        const closeDemoBtn = document.getElementById('closeDemoBtn');
        
        // Broadcast elements
        const broadcastTitle = document.getElementById('broadcastTitle');
        const broadcastMessage = document.getElementById('broadcastMessage');
        const sendBroadcastBtn = document.getElementById('sendBroadcastBtn');
        const testBroadcastBtn = document.getElementById('testBroadcastBtn');
        const clearBroadcastBtn = document.getElementById('clearBroadcastBtn');
        
        // State variables
        let alarms = JSON.parse(localStorage.getItem('alarms')) || [];
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let unreadCount = parseInt(localStorage.getItem('unreadCount')) || 0;
        let alarmCheckInterval;
        let userId = localStorage.getItem('userId') || generateUserId();
        let userName = localStorage.getItem('userName') || `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${Math.floor(Math.random() * 1000)}`;
        
        // Broadcast state
        let broadcastNotifications = JSON.parse(localStorage.getItem('broadcastNotifications')) || [];
        let broadcastUnreadCount = parseInt(localStorage.getItem('broadcastUnreadCount')) || 0;
        
        // SweetAlert2 configuration
        const SwalConfig = {
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#3b82f6',
            cancelButtonColor: '#6b7280',
            reverseButtons: true
        };
        
        // Initialize the app
        function init() {
            // Generate user ID if not exists
            if (!localStorage.getItem('userId')) {
                localStorage.setItem('userId', userId);
                localStorage.setItem('userName', userName);
            }
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
            dateInput.value = today;
            
            // Set default time to next hour
            const nextHour = new Date();
            nextHour.setHours(nextHour.getHours() + 1);
            timeInput.value = `${nextHour.getHours().toString().padStart(2, '0')}:00`;
            
            updateCurrentTime();
            renderAlarms();
            updateSyncCount();
            
            // Check alarms every second
            alarmCheckInterval = setInterval(checkAlarms, 1000);
            
            // Update current time every second
            setInterval(updateCurrentTime, 1000);
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(() => {
                    Notification.requestPermission();
                }, 2000);
            }
            
            // Load broadcast messages
            loadBroadcastMessages();
            
            // Test connection
            testConnection();
        }
        
        // Generate unique user ID
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Update current time display
        function updateCurrentTime() {
            const now = new Date();
            currentTimeElement.textContent = now.toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            currentDateElement.textContent = now.toLocaleDateString('th-TH', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        // Update sync count display
        function updateSyncCount() {
            const syncCount = alarms.filter(alarm => alarm.synced).length;
            syncCountElement.textContent = syncCount;
        }
        
        // Render active alarms
        function renderAlarms() {
            if (alarms.length === 0) {
                activeAlarms.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-clock text-4xl mb-4"></i>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ</p>
                        <p class="text-sm mt-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢</p>
                    </div>
                `;
                totalAlarmsElement.textContent = '0';
                nextAlarmTimeElement.textContent = '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡πÑ‡∏°‡πà‡∏°‡∏µ';
                return;
            }
            
            // Sort alarms by datetime
            alarms.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            activeAlarms.innerHTML = '';
            let nextAlarm = null;
            
            alarms.forEach((alarm, index) => {
                const alarmDate = new Date(alarm.datetime);
                const now = new Date();
                const isPast = alarmDate < now;
                
                if (!nextAlarm && !isPast && !alarm.triggered) {
                    nextAlarm = alarm;
                }
                
                const alarmElement = document.createElement('div');
                alarmElement.className = `bg-gray-800 rounded-xl p-4 border-l-4 ${isPast ? 'border-gray-600' : 'border-blue-500'} ${alarm.triggered ? 'opacity-70' : ''}`;
                alarmElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-bold ${isPast ? 'text-gray-400' : 'text-white'}">${alarm.title}</h3>
                            <p class="text-gray-400 text-sm mt-1">${alarm.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</p>
                            <div class="flex items-center mt-3">
                                <span class="text-xs px-2 py-1 rounded ${isPast ? 'bg-gray-700 text-gray-400' : 'bg-blue-900 text-blue-300'}">
                                    <i class="far fa-clock mr-1"></i>
                                    ${alarmDate.toLocaleDateString('th-TH')} ${alarmDate.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}
                                </span>
                                ${alarm.repeat !== 'none' ? 
                                    `<span class="text-xs px-2 py-1 rounded bg-purple-900 text-purple-300 ml-2">
                                        <i class="fas fa-redo mr-1"></i>${getRepeatText(alarm.repeat)}
                                    </span>` : ''
                                }
                                ${alarm.triggered ? 
                                    `<span class="text-xs px-2 py-1 rounded bg-green-900 text-green-300 ml-2">
                                        <i class="fas fa-check mr-1"></i>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                                    </span>` : ''
                                }
                                ${alarm.synced ? 
                                    `<span class="text-xs px-2 py-1 rounded bg-green-900 text-green-300 ml-2">
                                        <i class="fas fa-cloud mr-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                                    </span>` : ''
                                }
                            </div>
                        </div>
                        <button class="delete-alarm ml-2 text-gray-500 hover:text-red-400" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                activeAlarms.appendChild(alarmElement);
            });
            
            // Update next alarm display
            if (nextAlarm) {
                const nextAlarmDate = new Date(nextAlarm.datetime);
                nextAlarmTimeElement.textContent = `‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${nextAlarmDate.toLocaleDateString('th-TH')} ${nextAlarmDate.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}`;
            } else {
                nextAlarmTimeElement.textContent = '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡πÑ‡∏°‡πà‡∏°‡∏µ';
            }
            
            totalAlarmsElement.textContent = alarms.length;
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-alarm').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteAlarm(index);
                });
            });
        }
        
        // Get repeat option text
        function getRepeatText(repeatValue) {
            const repeatMap = {
                'none': '‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏ã‡πâ‡∏≥',
                'daily': '‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô',
                'weekly': '‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
                'monthly': '‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'
            };
            return repeatMap[repeatValue] || repeatValue;
        }
        
        // Check for alarms that need to be triggered
        function checkAlarms() {
            const now = new Date();
            
            alarms.forEach((alarm, index) => {
                const alarmDate = new Date(alarm.datetime);
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‡πÅ‡∏•‡∏∞‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                if (!alarm.triggered && alarmDate <= now) {
                    console.log('üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß:', alarm.title);
                    triggerAlarm(index);
                    
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏≥‡∏ã‡πâ‡∏≥ ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà
                    if (alarm.repeat !== 'none') {
                        rescheduleRepeatingAlarm(index);
                    }
                }
            });
        }
        
        // Trigger an alarm
        function triggerAlarm(index) {
            const alarm = alarms[index];
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            alarms[index].triggered = true;
            alarms[index].triggered_at = new Date().toISOString();
            localStorage.setItem('alarms', JSON.stringify(alarms));
            
            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets ‡∏ß‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß
            saveToGoogleSheets(alarm, 'triggered');
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            const notification = {
                id: Date.now(),
                title: alarm.title,
                description: alarm.description || '‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß!',
                datetime: new Date().toISOString(),
                read: false,
                type: 'alarm'
            };
            
            notifications.unshift(notification);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            unreadCount++;
            localStorage.setItem('unreadCount', unreadCount);
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            renderAlarms();
            updateBadges();
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            showNotification(alarm);
            
            // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            playNotificationSound();
        }
        
        // Save data to Google Sheets
        async function saveToGoogleSheets(alarmData, status = 'created') {
            try {
                console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets:', alarmData.title);
                
                const payload = {
                    action: 'add',
                    date: alarmData.date || new Date(alarmData.datetime).toLocaleDateString('th-TH'),
                    time: alarmData.time || new Date(alarmData.datetime).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}),
                    title: alarmData.title,
                    description: alarmData.description || '',
                    repeat: alarmData.repeat || 'none',
                    status: status,
                    triggered_at: alarmData.triggered_at || '',
                    user_id: userId,
                    user_name: userName,
                    alarm_id: alarmData.id || ''
                };
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL parameters
                const params = new URLSearchParams();
                for (const key in payload) {
                    params.append(key, payload[key]);
                }
                
                // ‡πÉ‡∏ä‡πâ GET request
                const response = await fetch(GOOGLE_SCRIPT_URL + '?' + params.toString(), {
                    method: "GET"
                });
                
                const data = await response.text();
                console.log('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', data);
                
                // Mark the alarm as synced
                const alarmIndex = alarms.findIndex(a => a.id === alarmData.id);
                if (alarmIndex !== -1) {
                    alarms[alarmIndex].synced = true;
                    localStorage.setItem('alarms', JSON.stringify(alarms));
                    updateSyncCount();
                }
                
                return true;
            } catch (error) {
                console.error('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets:', error);
                return false;
            }
        }
        
        // Delete from Google Sheets
        async function deleteFromGoogleSheets(alarmId) {
            try {
                console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google Sheets:', alarmId);
                
                const payload = {
                    action: 'delete',
                    alarm_id: alarmId,
                    user_id: userId
                };
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL parameters
                const params = new URLSearchParams();
                for (const key in payload) {
                    params.append(key, payload[key]);
                }
                
                const response = await fetch(GOOGLE_SCRIPT_URL + '?' + params.toString(), {
                    method: "GET"
                });
                
                const data = await response.text();
                console.log('‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', data);
                return true;
            } catch (error) {
                console.error('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google Sheets:', error);
                return false;
            }
        }
        
        // Show notification
        function showNotification(alarm) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`‚è∞ ${alarm.title}`, {
                    body: alarm.description || '‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß!',
                    icon: 'https://cdn-icons-png.flaticon.com/512/565/565422.png',
                    tag: 'alarm-notification'
                });
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            showInAppNotification(alarm);
        }
        
        // Show in-app notification
        function showInAppNotification(alarm) {
            demoTitle.textContent = `‚è∞ ${alarm.title}`;
            demoDesc.textContent = alarm.description || '‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß!';
            demoTime.textContent = new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
            
            demoNotification.classList.remove('hidden');
            
            // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setTimeout(() => {
                demoNotification.classList.add('hidden');
            }, 10000);
        }
        
        // Play notification sound
        function playNotificationSound() {
            try {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÜ
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ:", e);
            }
        }
        
        // Reschedule repeating alarm
        function rescheduleRepeatingAlarm(index) {
            const alarm = alarms[index];
            const alarmDate = new Date(alarm.datetime);
            
            switch (alarm.repeat) {
                case 'daily':
                    alarmDate.setDate(alarmDate.getDate() + 1);
                    break;
                case 'weekly':
                    alarmDate.setDate(alarmDate.getDate() + 7);
                    break;
                case 'monthly':
                    alarmDate.setMonth(alarmDate.getMonth() + 1);
                    break;
            }
            
            const newAlarm = {
                id: Date.now(),
                title: alarm.title,
                description: alarm.description,
                date: alarm.date,
                time: alarm.time,
                datetime: alarmDate.toISOString(),
                repeat: alarm.repeat,
                triggered: false,
                synced: false
            };
            
            alarms.push(newAlarm);
            localStorage.setItem('alarms', JSON.stringify(alarms));
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets
            saveToGoogleSheets(newAlarm, 'created');
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            renderAlarms();
        }
        
        // Delete an alarm
        async function deleteAlarm(index) {
            const alarm = alarms[index];
            
            // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
            const result = await Swal.fire({
                icon: 'warning',
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                html: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô<br>
                      <strong>"${alarm.title}"</strong><br>
                      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date(alarm.datetime).toLocaleDateString('th-TH')} ‡πÄ‡∏ß‡∏•‡∏≤ ${new Date(alarm.datetime).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}?`,
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                ...SwalConfig
            });
            
            if (!result.isConfirmed) return;
            
            // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google Sheets ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
            if (alarm.synced) {
                await deleteFromGoogleSheets(alarm.id);
            }
            
            // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å localStorage
            alarms.splice(index, 1);
            localStorage.setItem('alarms', JSON.stringify(alarms));
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            renderAlarms();
            updateSyncCount();
            
            Swal.fire({
                icon: 'success',
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: '‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                ...SwalConfig
            });
        }
        
        // Clear all alarms
        async function clearAllAlarms() {
            if (alarms.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ',
                    text: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö',
                    ...SwalConfig
                });
                return;
            }
            
            const result = await Swal.fire({
                icon: 'warning',
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                html: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong>${alarms.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                ...SwalConfig
            });
            
            if (!result.isConfirmed) return;
            
            // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google Sheets ‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
            for (const alarm of alarms) {
                if (alarm.synced) {
                    await deleteFromGoogleSheets(alarm.id);
                }
            }
            
            // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å localStorage
            alarms = [];
            localStorage.setItem('alarms', JSON.stringify(alarms));
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            renderAlarms();
            updateSyncCount();
            
            Swal.fire({
                icon: 'success',
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: '‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                ...SwalConfig
            });
        }
        
        // Form submission handler
        alarmForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = titleInput.value.trim();
            const description = descriptionInput.value.trim();
            const date = dateInput.value;
            const time = timeInput.value;
            const repeat = document.querySelector('input[name="repeat"]:checked').value;
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (!title || !date || !time) {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡πÄ‡∏ß‡∏•‡∏≤)',
                    ...SwalConfig
                });
                return;
            }
            
            const datetime = new Date(`${date}T${time}`);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (datetime <= new Date()) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï',
                    ...SwalConfig
                });
                return;
            }
            
            const alarm = {
                id: Date.now(),
                title,
                description,
                date,
                time,
                datetime: datetime.toISOString(),
                repeat,
                triggered: false,
                synced: false
            };
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            alarms.push(alarm);
            localStorage.setItem('alarms', JSON.stringify(alarms));
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets
            const saved = await saveToGoogleSheets(alarm, 'created');
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
            alarmForm.reset();
            dateInput.value = new Date().toISOString().split('T')[0];
            const nextHour = new Date();
            nextHour.setHours(nextHour.getHours() + 1);
            timeInput.value = `${nextHour.getHours().toString().padStart(2, '0')}:00`;
            document.querySelector('input[name="repeat"][value="none"]').checked = true;
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            renderAlarms();
            
            Swal.fire({
                icon: 'success',
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: `‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô "${title}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!${saved ? ' (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Google Sheets ‡πÅ‡∏•‡πâ‡∏ß)' : ' (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)'}`,
                ...SwalConfig
            });
        });
        
        // Clear form button
        clearBtn.addEventListener('click', function() {
            alarmForm.reset();
            dateInput.value = new Date().toISOString().split('T')[0];
            const nextHour = new Date();
            nextHour.setHours(nextHour.getHours() + 1);
            timeInput.value = `${nextHour.getHours().toString().padStart(2, '0')}:00`;
            document.querySelector('input[name="repeat"][value="none"]').checked = true;
            
            Swal.fire({
                icon: 'success',
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: '‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                ...SwalConfig
            });
        });
        
        // Clear all alarms button
        clearAllBtn.addEventListener('click', clearAllAlarms);
        
        // Close demo notification button
        closeDemoBtn.addEventListener('click', function() {
            demoNotification.classList.add('hidden');
        });
        
        // Load broadcast messages
        function loadBroadcastMessages() {
            const broadcastDB = JSON.parse(localStorage.getItem('broadcastDB')) || {
                messages: [],
                lastUpdated: new Date().toISOString()
            };
            
            broadcastNotifications = broadcastDB.messages || [];
            
            // Calculate unread broadcast messages
            broadcastUnreadCount = broadcastNotifications.filter(msg => 
                !msg.readBy || !msg.readBy.includes(userId)
            ).length;
            
            localStorage.setItem('broadcastNotifications', JSON.stringify(broadcastNotifications));
            localStorage.setItem('broadcastUnreadCount', broadcastUnreadCount);
            
            // Update broadcast count display
            document.getElementById('totalBroadcasts').textContent = broadcastDB.messages.length;
            
            // Update badges
            updateBadges();
        }
        
        // Send broadcast message
        async function sendBroadcastToAll(title, message) {
            try {
                // Create broadcast message
                const broadcastMessage = {
                    id: 'broadcast_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    title: title,
                    message: message,
                    sender: userId,
                    senderName: userName,
                    timestamp: new Date().toISOString(),
                    readBy: []
                };
                
                // Get existing broadcast database
                const broadcastDB = JSON.parse(localStorage.getItem('broadcastDB')) || {
                    messages: [],
                    lastUpdated: new Date().toISOString()
                };
                
                // Add new message at the beginning
                broadcastDB.messages.unshift(broadcastMessage);
                
                // Keep only last 100 messages
                if (broadcastDB.messages.length > 100) {
                    broadcastDB.messages = broadcastDB.messages.slice(0, 100);
                }
                
                broadcastDB.lastUpdated = new Date().toISOString();
                
                // Save to local storage
                localStorage.setItem('broadcastDB', JSON.stringify(broadcastDB));
                
                // Add to local notifications
                broadcastNotifications.unshift(broadcastMessage);
                localStorage.setItem('broadcastNotifications', JSON.stringify(broadcastNotifications));
                
                // Update broadcast unread count
                broadcastUnreadCount++;
                localStorage.setItem('broadcastUnreadCount', broadcastUnreadCount);
                
                // Update badges and display
                updateBadges();
                document.getElementById('totalBroadcasts').textContent = broadcastDB.messages.length;
                
                // Save to Google Sheets for record
                const sheetResult = await saveBroadcastToGoogleSheets(title, message);
                
                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: `‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® "${title}" ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!${sheetResult ? ' (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Google Sheets)' : ' (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)'}`,
                    ...SwalConfig
                });
                
                return true;
            } catch (error) {
                console.error('Error sending broadcast:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏î‡πâ: ' + error.message,
                    ...SwalConfig
                });
                return false;
            }
        }
        
        // Save broadcast to Google Sheets
        async function saveBroadcastToGoogleSheets(title, message) {
            try {
                const payload = {
                    action: 'add',
                    date: new Date().toLocaleDateString('th-TH'),
                    time: new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}),
                    title: `üì¢ ${title}`,
                    description: message,
                    repeat: 'none',
                    status: 'broadcast',
                    triggered_at: new Date().toISOString(),
                    broadcast: true,
                    user_id: userId,
                    user_name: userName
                };
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL parameters
                const params = new URLSearchParams();
                for (const key in payload) {
                    params.append(key, payload[key]);
                }
                
                const response = await fetch(GOOGLE_SCRIPT_URL + '?' + params.toString(), {
                    method: "GET"
                });
                
                const data = await response.text();
                console.log('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏•‡∏á Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', data);
                return true;
            } catch (error) {
                console.error('Error saving broadcast to Google Sheets:', error);
                return false;
            }
        }
        
        // Test broadcast
        function testBroadcast(title, message) {
            const testMessage = {
                id: 'test_' + Date.now(),
                title: title || '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
                message: message || '‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
                sender: 'system',
                senderName: '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
                timestamp: new Date().toISOString(),
                readBy: []
            };
            
            broadcastNotifications.unshift(testMessage);
            localStorage.setItem('broadcastNotifications', JSON.stringify(broadcastNotifications));
            
            broadcastUnreadCount++;
            localStorage.setItem('broadcastUnreadCount', broadcastUnreadCount);
            
            updateBadges();
            
            // Show notification
            demoTitle.textContent = `üì¢ ${testMessage.title}`;
            demoDesc.textContent = testMessage.message;
            demoTime.textContent = new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
            demoNotification.classList.remove('hidden');
            
            Swal.fire({
                icon: 'success',
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: '‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                ...SwalConfig
            });
        }
        
        // Update badges
        function updateBadges() {
            const totalUnread = unreadCount + broadcastUnreadCount;
            
            // Update badge elements
            const badgeElements = [
                document.getElementById('notificationBadge'),
                document.getElementById('mobileBadge'),
                document.getElementById('mobileNavBadge'),
                document.getElementById('fabBadge'),
                document.getElementById('panelBadge')
            ];
            
            badgeElements.forEach(badge => {
                if (badge) {
                    if (totalUnread > 0) {
                        badge.textContent = totalUnread > 99 ? '99+' : totalUnread;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            });
            
            // Update page title
            document.title = totalUnread > 0 ? `(${totalUnread}) ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå` : '‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå';
        }
        
        // Send broadcast button
        sendBroadcastBtn.addEventListener('click', async function() {
            const title = broadcastTitle.value.trim();
            const message = broadcastMessage.value.trim();
            
            if (!title || !message) {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
                    ...SwalConfig
                });
                return;
            }
            
            if (title.length > 50) {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ',
                    text: '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 50 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)',
                    ...SwalConfig
                });
                return;
            }
            
            if (message.length > 200) {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ',
                    text: '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 200 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)',
                    ...SwalConfig
                });
                return;
            }
            
            const result = await Swal.fire({
                icon: 'question',
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
                html: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®<br>
                      <strong>"${title}"</strong><br>
                      ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö?`,
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                ...SwalConfig
            });
            
            if (result.isConfirmed) {
                await sendBroadcastToAll(title, message);
            }
        });
        
        // Test broadcast button
        testBroadcastBtn.addEventListener('click', function() {
            const title = broadcastTitle.value.trim() || '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®';
            const message = broadcastMessage.value.trim() || '‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®';
            
            Swal.fire({
                icon: 'info',
                title: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
                html: `‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ó‡∏î‡∏™‡∏≠‡∏ö:<br>
                      <strong>"${title}"</strong><br>
                      ${message}`,
                showCancelButton: true,
                confirmButtonText: '‡∏™‡πà‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                ...SwalConfig
            }).then((result) => {
                if (result.isConfirmed) {
                    testBroadcast(title, message);
                }
            });
        });
        
        // Clear broadcast form button
        clearBroadcastBtn.addEventListener('click', function() {
            broadcastTitle.value = '';
            broadcastMessage.value = '';
            
            Swal.fire({
                icon: 'success',
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: '‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                ...SwalConfig
            });
        });
        
        // Test connection
        async function testConnection() {
            try {
                const params = new URLSearchParams({
                    action: 'test',
                    test: 'connection',
                    user_id: userId
                });
                
                const response = await fetch(GOOGLE_SCRIPT_URL + '?' + params.toString(), {
                    method: "GET"
                });
                
                const data = await response.text();
                console.log('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', data);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                const statusText = document.getElementById('statusText');
                if (statusText) {
                    statusText.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets';
                    statusText.className = 'text-sm status-connected';
                }
                
            } catch (error) {
                console.log('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡πÑ‡∏î‡πâ:', error);
                
                const statusText = document.getElementById('statusText');
                if (statusText) {
                    statusText.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets';
                    statusText.className = 'text-sm status-disconnected';
                }
            }
        }
        
        // Initialize the application
        init();
    </script>
</body>
</html>
