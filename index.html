<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แอปแจ้งเตือน - ทำงานในพื้นหลังได้</title>
    <meta name="description" content="เว็บแอปแจ้งเตือนแบบมือถือ สามารถทำงานในพื้นหลังและแจ้งเตือนแม้ปิดเบราว์เซอร์">
    <meta name="theme-color" content="#2196F3">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192x192.png" type="image/png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Prompt', 'Sukhumvit Set', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .app-header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .app-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .app-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Install Banner */
        .install-banner {
            background: linear-gradient(to right, #4CAF50, #45a049);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: none;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .install-banner.show {
            display: flex;
        }
        
        /* Status Cards */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
        }
        
        .status-card h3 {
            color: #2196F3;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
        }
        
        .status-card h3 i {
            width: 40px;
            height: 40px;
            background: #2196F3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-dot.active {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        .status-dot.inactive {
            background: #f44336;
        }
        
        .status-dot.waiting {
            background: #FF9800;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .control-panel {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        
        .notification-log {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            max-height: 500px;
            overflow-y: auto;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .log-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .log-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #2196F3;
            animation: fadeIn 0.5s;
        }
        
        .log-item.success {
            border-left-color: #4CAF50;
        }
        
        .log-item.error {
            border-left-color: #f44336;
        }
        
        .log-item.warning {
            border-left-color: #FF9800;
        }
        
        .log-time {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        
        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        /* Buttons */
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
            min-width: 140px;
        }
        
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0d8bf2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .btn-warning {
            background: #FF9800;
            color: white;
        }
        
        .btn-warning:hover {
            background: #f57c00;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53935;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
        }
        
        .btn-secondary {
            background: #757575;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #616161;
            transform: translateY(-2px);
        }
        
        /* Scheduled List */
        .scheduled-list {
            margin-top: 30px;
        }
        
        .scheduled-item {
            background: #f0f7ff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #2196F3;
        }
        
        .scheduled-item.soon {
            border-left-color: #FF9800;
            background: #fff8e1;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }
        
        .toast {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideInRight 0.3s;
            border-left: 5px solid #4CAF50;
        }
        
        .toast.error {
            border-left-color: #f44336;
        }
        
        .toast.warning {
            border-left-color: #FF9800;
        }
        
        .toast.info {
            border-left-color: #2196F3;
        }
        
        .toast-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .toast.success .toast-icon {
            background: #4CAF50;
        }
        
        .toast.error .toast-icon {
            background: #f44336;
        }
        
        .toast.warning .toast-icon {
            background: #FF9800;
        }
        
        .toast.info .toast-icon {
            background: #2196F3;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            padding: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toast-close:hover {
            background: #f5f5f5;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Footer */
        .app-footer {
            text-align: center;
            color: white;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.9rem;
        }
        
        /* Instructions */
        .instructions {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        
        .instructions h3 {
            color: #2196F3;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .step {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: #2196F3;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 auto 15px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .app-header h1 {
                font-size: 2rem;
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                min-width: 100%;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Install Banner -->
        <div class="install-banner" id="installBanner">
            <div>
                <strong>ติดตั้งแอปนี้บนอุปกรณ์ของคุณ!</strong>
                <div style="font-size: 0.9rem; margin-top: 5px;">รับการแจ้งเตือนแม้ปิดเบราว์เซอร์</div>
            </div>
            <button class="btn btn-success" id="installBtn">
                <i class="fas fa-download"></i> ติดตั้งแอป
            </button>
        </div>

        <!-- Header -->
        <header class="app-header">
            <h1>
                <i class="fas fa-bell"></i>
                <span>ระบบแจ้งเตือนอัจฉริยะ</span>
            </h1>
            <p>เว็บแอปพลิเคชันที่สามารถแจ้งเตือนได้แม้ปิดเบราว์เซอร์หรือปิดแท็บ ทำงานในพื้นหลังเหมือนแอปมือถือ</p>
        </header>

        <!-- Status Overview -->
        <div class="status-grid">
            <div class="status-card">
                <h3><i class="fas fa-cogs"></i> สถานะระบบ</h3>
                <div class="status-item">
                    <span>Service Worker:</span>
                    <div class="status-indicator">
                        <div class="status-dot" id="swStatus"></div>
                        <span id="swStatusText">กำลังตรวจสอบ...</span>
                    </div>
                </div>
                <div class="status-item">
                    <span>การแจ้งเตือน:</span>
                    <div class="status-indicator">
                        <div class="status-dot" id="notificationStatus"></div>
                        <span id="notificationStatusText">กำลังตรวจสอบ...</span>
                    </div>
                </div>
                <div class="status-item">
                    <span>การทำงานพื้นหลัง:</span>
                    <div class="status-indicator">
                        <div class="status-dot" id="backgroundStatus"></div>
                        <span id="backgroundStatusText">กำลังตรวจสอบ...</span>
                    </div>
                </div>
            </div>

            <div class="status-card">
                <h3><i class="fas fa-chart-bar"></i> สถิติ</h3>
                <div class="status-item">
                    <span>แจ้งเตือนที่ตั้งเวลาไว้:</span>
                    <span id="scheduledCount">0</span>
                </div>
                <div class="status-item">
                    <span>แจ้งเตือนที่ส่งแล้ว:</span>
                    <span id="sentCount">0</span>
                </div>
                <div class="status-item">
                    <span>แจ้งเตือนถัดไป:</span>
                    <span id="nextNotification">-</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Control Panel -->
            <div class="control-panel">
                <h3><i class="fas fa-sliders-h"></i> ตั้งค่าการแจ้งเตือน</h3>
                
                <div class="form-group">
                    <label for="notificationTitle"><i class="fas fa-heading"></i> หัวข้อการแจ้งเตือน:</label>
                    <input type="text" id="notificationTitle" class="form-control" 
                           placeholder="เช่น: การนัดหมายสำคัญ" 
                           value="การแจ้งเตือนจากเว็บแอป">
                </div>
                
                <div class="form-group">
                    <label for="notificationMessage"><i class="fas fa-comment-alt"></i> ข้อความ:</label>
                    <textarea id="notificationMessage" class="form-control" rows="3" 
                              placeholder="กรอกข้อความการแจ้งเตือนที่นี่...">
แจ้งเตือนทดสอบจากเว็บแอปพลิเคชัน ที่ทำงานในพื้นหลังได้แม้ปิดเบราว์เซอร์</textarea>
                </div>
                
                <div class="form-group">
                    <label for="scheduleTime"><i class="fas fa-clock"></i> ตั้งเวลา (นาที):</label>
                    <input type="number" id="scheduleTime" class="form-control" 
                           min="1" max="10080" value="5" 
                           placeholder="ระบุเวลาเป็นนาที (สูงสุด 7 วัน)">
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                        <i class="fas fa-info-circle"></i> สามารถตั้งเวลาได้สูงสุด 7 วัน (10,080 นาที)
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" id="scheduleBtn">
                        <i class="fas fa-clock"></i> ตั้งเวลาแจ้งเตือน
                    </button>
                    <button class="btn btn-primary" id="sendNowBtn">
                        <i class="fas fa-paper-plane"></i> ส่งทันที
                    </button>
                </div>

                <!-- Quick Actions -->
                <div style="margin-top: 30px;">
                    <h4><i class="fas fa-bolt"></i> การดำเนินการด่วน</h4>
                    <div class="btn-group" style="margin-top: 15px;">
                        <button class="btn btn-warning" id="permissionBtn">
                            <i class="fas fa-hand-paper"></i> ขออนุญาต
                        </button>
                        <button class="btn btn-secondary" id="registerSWBtn">
                            <i class="fas fa-download"></i> ติดตั้ง Service Worker
                        </button>
                        <button class="btn btn-danger" id="clearAllBtn">
                            <i class="fas fa-trash"></i> ล้างทั้งหมด
                        </button>
                    </div>
                </div>

                <!-- Scheduled Notifications -->
                <div class="scheduled-list">
                    <h4 style="margin-bottom: 15px;">
                        <i class="fas fa-calendar-alt"></i> การแจ้งเตือนที่ตั้งเวลาไว้
                    </h4>
                    <div id="scheduledNotifications">
                        <!-- จะแสดงรายการที่ตั้งเวลาไว้ที่นี่ -->
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-clock fa-2x" style="margin-bottom: 10px; display: block;"></i>
                            ยังไม่มีการตั้งเวลาแจ้งเตือน
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification Log -->
            <div class="notification-log">
                <div class="log-header">
                    <h3><i class="fas fa-history"></i> บันทึกการทำงาน</h3>
                    <button class="btn btn-secondary" id="clearLogBtn" style="padding: 8px 16px;">
                        <i class="fas fa-broom"></i> ล้าง
                    </button>
                </div>
                
                <div class="log-list" id="notificationLog">
                    <div class="log-item">
                        <div>
                            <strong>เริ่มต้นระบบแจ้งเตือน</strong>
                            <div>ระบบพร้อมใช้งานแล้ว</div>
                            <div class="log-time" id="currentTime"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            <h3><i class="fas fa-graduation-cap"></i> วิธีใช้งาน</h3>
            <p>เพื่อให้ระบบทำงานได้เต็มประสิทธิภาพและสามารถแจ้งเตือนได้แม้ปิดเบราว์เซอร์ กรุณาดำเนินการตามขั้นตอนต่อไปนี้:</p>
            
            <div class="steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <h4>ติดตั้ง Service Worker</h4>
                    <p>คลิกปุ่ม "ติดตั้ง Service Worker" เพื่อให้แอปสามารถทำงานในพื้นหลังได้</p>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <h4>ขออนุญาตการแจ้งเตือน</h4>
                    <p>คลิกปุ่ม "ขออนุญาต" เพื่ออนุญาตให้แอปส่งการแจ้งเตือนผ่านระบบปฏิบัติการ</p>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <h4>ตั้งเวลาแจ้งเตือน</h4>
                    <p>กรอกข้อมูลและตั้งเวลา จากนั้นคลิกปุ่ม "ตั้งเวลาแจ้งเตือน"</p>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <h4>ทดสอบการทำงาน</h4>
                    <p>ปิดเบราว์เซอร์แล้วรอจนถึงเวลาที่ตั้งไว้ ระบบจะแจ้งเตือนอัตโนมัติ</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="app-footer">
            <p>© 2023 ระบบแจ้งเตือนอัจฉริยะ - พัฒนาด้วย Progressive Web App Technology</p>
            <p style="margin-top: 5px; font-size: 0.8rem;">
                <i class="fas fa-info-circle"></i> รองรับ Chrome, Edge, Firefox และ Safari รุ่นใหม่
            </p>
        </footer>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Audio for Notification Sound -->
    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>

    <!-- Main JavaScript -->
    <script>
        // Global Variables
        let deferredPrompt = null;
        let scheduledNotifications = [];
        let serviceWorkerRegistration = null;
        let isAppInstalled = false;
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Main initialization function
        async function initializeApp() {
            logMessage('เริ่มต้นระบบแจ้งเตือนอัจฉริยะ', 'info');
            updateCurrentTime();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check system capabilities
            checkSystemCapabilities();
            
            // Check and register service worker
            await checkServiceWorkerStatus();
            
            // Check notification permission
            checkNotificationPermission();
            
            // Load scheduled notifications from storage
            await loadScheduledNotifications();
            
            // Start checking for scheduled notifications
            startNotificationChecker();
            
            // Update time every second
            setInterval(updateCurrentTime, 1000);
            
            // Update status periodically
            setInterval(updateSystemStatus, 30000);
            
            // Check for PWA install prompt
            setupInstallPrompt();
            
            logMessage('ระบบพร้อมใช้งานแล้ว', 'success');
        }
        
        // Setup all event listeners
        function setupEventListeners() {
            // Button click handlers
            document.getElementById('scheduleBtn').addEventListener('click', scheduleNotification);
            document.getElementById('sendNowBtn').addEventListener('click', sendImmediateNotification);
            document.getElementById('permissionBtn').addEventListener('click', requestNotificationPermission);
            document.getElementById('registerSWBtn').addEventListener('click', registerServiceWorker);
            document.getElementById('clearAllBtn').addEventListener('click', clearAllNotifications);
            document.getElementById('clearLogBtn').addEventListener('click', clearLog);
            document.getElementById('installBtn').addEventListener('click', installPWA);
            
            // Before install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallBanner();
            });
            
            // App installed
            window.addEventListener('appinstalled', () => {
                isAppInstalled = true;
                hideInstallBanner();
                showToast('ติดตั้งแอปสำเร็จ!', 'success', 'ตอนนี้คุณสามารถใช้งานแอปได้แม้ไม่มีอินเทอร์เน็ต');
                logMessage('ผู้ใช้ติดตั้งแอปเป็น PWA แล้ว', 'success');
            });
        }
        
        // Check system capabilities
        function checkSystemCapabilities() {
            const capabilities = {
                serviceWorker: 'serviceWorker' in navigator,
                pushManager: 'PushManager' in window,
                notifications: 'Notification' in window,
                indexedDB: 'indexedDB' in window,
                backgroundSync: 'SyncManager' in window,
                periodicSync: 'PeriodicSyncManager' in window
            };
            
            // Update background status
            const bgStatus = document.getElementById('backgroundStatus');
            const bgStatusText = document.getElementById('backgroundStatusText');
            
            if (capabilities.serviceWorker && capabilities.pushManager) {
                bgStatus.className = 'status-dot active';
                bgStatusText.textContent = 'พร้อมใช้งาน';
            } else {
                bgStatus.className = 'status-dot inactive';
                bgStatusText.textContent = 'ไม่รองรับ';
            }
            
            logMessage(`ความสามารถระบบ: ${JSON.stringify(capabilities)}`, 'info');
        }
        
        // Check and update service worker status
        async function checkServiceWorkerStatus() {
            const swStatus = document.getElementById('swStatus');
            const swStatusText = document.getElementById('swStatusText');
            
            if (!('serviceWorker' in navigator)) {
                swStatus.className = 'status-dot inactive';
                swStatusText.textContent = 'ไม่รองรับ';
                logMessage('เบราว์เซอร์นี้ไม่รองรับ Service Worker', 'warning');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                
                if (registration) {
                    serviceWorkerRegistration = registration;
                    swStatus.className = 'status-dot active';
                    swStatusText.textContent = 'ทำงานอยู่';
                    
                    // Listen for updates
                    registration.addEventListener('updatefound', () => {
                        logMessage('พบเวอร์ชันใหม่ของ Service Worker', 'info');
                    });
                    
                    logMessage('Service Worker ทำงานปกติ', 'success');
                } else {
                    swStatus.className = 'status-dot waiting';
                    swStatusText.textContent = 'ยังไม่ได้ติดตั้ง';
                    logMessage('กรุณาติดตั้ง Service Worker', 'warning');
                }
            } catch (error) {
                swStatus.className = 'status-dot inactive';
                swStatusText.textContent = 'ข้อผิดพลาด';
                logMessage(`ข้อผิดพลาด Service Worker: ${error.message}`, 'error');
            }
        }
        
        // Register service worker
        async function registerServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                showToast('เบราว์เซอร์นี้ไม่รองรับ Service Worker', 'error');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.register('service-worker.js', {
                    scope: './'
                });
                
                serviceWorkerRegistration = registration;
                
                // Wait for service worker to be ready
                if (registration.installing) {
                    registration.installing.addEventListener('statechange', (e) => {
                        if (e.target.state === 'installed') {
                            showToast('ติดตั้ง Service Worker สำเร็จ!', 'success');
                            checkServiceWorkerStatus();
                            logMessage('Service Worker ติดตั้งเรียบร้อย', 'success');
                        }
                    });
                } else if (registration.active) {
                    showToast('Service Worker พร้อมใช้งานแล้ว!', 'success');
                    checkServiceWorkerStatus();
                    logMessage('Service Worker พร้อมใช้งาน', 'success');
                }
                
            } catch (error) {
                showToast('ติดตั้ง Service Worker ล้มเหลว', 'error');
                logMessage(`ติดตั้ง Service Worker ล้มเหลว: ${error.message}`, 'error');
            }
        }
        
        // Check notification permission status
        function checkNotificationPermission() {
            const notifStatus = document.getElementById('notificationStatus');
            const notifStatusText = document.getElementById('notificationStatusText');
            
            if (!('Notification' in window)) {
                notifStatus.className = 'status-dot inactive';
                notifStatusText.textContent = 'ไม่รองรับ';
                return;
            }
            
            const permission = Notification.permission;
            
            switch(permission) {
                case 'granted':
                    notifStatus.className = 'status-dot active';
                    notifStatusText.textContent = 'อนุญาตแล้ว';
                    break;
                case 'denied':
                    notifStatus.className = 'status-dot inactive';
                    notifStatusText.textContent = 'ปฏิเสธแล้ว';
                    break;
                default:
                    notifStatus.className = 'status-dot waiting';
                    notifStatusText.textContent = 'รอการอนุญาต';
            }
        }
        
        // Request notification permission
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showToast('เบราว์เซอร์นี้ไม่รองรับการแจ้งเตือน', 'error');
                return;
            }
            
            try {
                const permission = await Notification.requestPermission();
                
                checkNotificationPermission();
                
                if (permission === 'granted') {
                    showToast('ได้รับอนุญาตการแจ้งเตือนแล้ว!', 'success');
                    logMessage('ผู้ใช้อนุญาตการแจ้งเตือน', 'success');
                    
                    // Subscribe to push notifications
                    await subscribeToPushNotifications();
                    
                    // Send test notification
                    if (serviceWorkerRegistration) {
                        serviceWorkerRegistration.showNotification('การแจ้งเตือนทำงานแล้ว!', {
                            body: 'ตอนนี้คุณจะได้รับการแจ้งเตือนแม้ปิดเบราว์เซอร์',
                            icon: 'icons/icon-192x192.png',
                            badge: 'icons/icon-96x96.png',
                            tag: 'permission-granted'
                        });
                    }
                } else if (permission === 'denied') {
                    showToast('การแจ้งเตือนถูกปฏิเสธ', 'warning');
                    logMessage('ผู้ใช้ปฏิเสธการแจ้งเตือน', 'warning');
                }
            } catch (error) {
                showToast('ขออนุญาตล้มเหลว', 'error');
                logMessage(`ขออนุญาตล้มเหลว: ${error.message}`, 'error');
            }
        }
        
        // Subscribe to push notifications
        async function subscribeToPushNotifications() {
            if (!serviceWorkerRegistration || !('PushManager' in window)) {
                return;
            }
            
            try {
                // Generate VAPID key (in production, get from server)
                const vapidPublicKey = 'BEl62iUYgUivxIkv69yViEuiBIa-Ib9-SkvMeAtA3LFgDzkrxZJjSgSnfckjBJuBkr3qBUYIHBQFLXYp5Nksh8U';
                
                // Convert to Uint8Array
                const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);
                
                const subscription = await serviceWorkerRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                });
                
                // Save subscription locally (in production, send to server)
                localStorage.setItem('pushSubscription', JSON.stringify(subscription));
                logMessage('ลงทะเบียน Push Notifications สำเร็จ', 'success');
                
            } catch (error) {
                logMessage(`ลงทะเบียน Push ล้มเหลว: ${error.message}`, 'error');
            }
        }
        
        // Schedule a new notification
        async function scheduleNotification() {
            const title = document.getElementById('notificationTitle').value.trim();
            const message = document.getElementById('notificationMessage').value.trim();
            const minutes = parseInt(document.getElementById('scheduleTime').value);
            
            // Validation
            if (!title || !message) {
                showToast('กรุณากรอกหัวข้อและข้อความ', 'warning');
                return;
            }
            
            if (isNaN(minutes) || minutes < 1 || minutes > 10080) {
                showToast('กรุณาระบุเวลาระหว่าง 1-10080 นาที', 'warning');
                return;
            }
            
            // Create notification object
            const notificationId = 'notification-' + Date.now();
            const scheduledTime = Date.now() + (minutes * 60000);
            
            const notification = {
                id: notificationId,
                title: title,
                message: message,
                scheduledTime: scheduledTime,
                minutes: minutes,
                createdAt: Date.now(),
                status: 'scheduled'
            };
            
            // Add to array
            scheduledNotifications.push(notification);
            
            // Save to storage
            await saveScheduledNotification(notification);
            
            // Update UI
            updateScheduledNotificationsUI();
            updateStatistics();
            
            // Show confirmation
            const timeString = new Date(scheduledTime).toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const dateString = new Date(scheduledTime).toLocaleDateString('th-TH', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });
            
            showToast(
                'ตั้งเวลาแจ้งเตือนสำเร็จ!', 
                'success',
                `จะแจ้งเตือนวันที่ ${dateString} เวลา ${timeString}`
            );
            
            logMessage(
                `ตั้งเวลาแจ้งเตือน: "${title}" ในอีก ${minutes} นาที`,
                'info'
            );
            
            // Send to service worker for background processing
            if (serviceWorkerRegistration && serviceWorkerRegistration.active) {
                serviceWorkerRegistration.active.postMessage({
                    type: 'SCHEDULE_NOTIFICATION',
                    notification: notification
                });
            }
        }
        
        // Send immediate notification
        async function sendImmediateNotification() {
            const title = document.getElementById('notificationTitle').value.trim() || 'การแจ้งเตือน';
            const message = document.getElementById('notificationMessage').value.trim() || 'ข้อความแจ้งเตือน';
            
            // Check permission
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                showToast('กรุณาอนุญาตการแจ้งเตือนก่อน', 'warning');
                return;
            }
            
            // Send via service worker if available
            if (serviceWorkerRegistration && serviceWorkerRegistration.active) {
                serviceWorkerRegistration.showNotification(title, {
                    body: message,
                    icon: 'icons/icon-192x192.png',
                    badge: 'icons/icon-96x96.png',
                    tag: 'immediate-' + Date.now(),
                    requireInteraction: true
                });
            } else {
                // Fallback to regular notification
                new Notification(title, {
                    body: message,
                    icon: 'icons/icon-192x192.png'
                });
            }
            
            // Play sound
            playNotificationSound();
            
            // Show toast
            showToast('ส่งการแจ้งเตือนแล้ว!', 'success');
            
            // Log
            logMessage(`ส่งการแจ้งเตือนทันที: "${title}"`, 'info');
            
            // Update statistics
            updateStatistics();
        }
        
        // Update scheduled notifications UI
        function updateScheduledNotificationsUI() {
            const container = document.getElementById('scheduledNotifications');
            const now = Date.now();
            
            // Filter out past notifications
            const upcoming = scheduledNotifications.filter(n => 
                n.status === 'scheduled' && n.scheduledTime > now
            );
            
            if (upcoming.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <i class="fas fa-clock fa-2x" style="margin-bottom: 10px; display: block;"></i>
                        ยังไม่มีการตั้งเวลาแจ้งเตือน
                    </div>
                `;
                return;
            }
            
            // Sort by time
            upcoming.sort((a, b) => a.scheduledTime - b.scheduledTime);
            
            let html = '';
            
            upcoming.forEach(notification => {
                const timeRemaining = notification.scheduledTime - now;
                const minutesRemaining = Math.ceil(timeRemaining / 60000);
                const hoursRemaining = Math.floor(minutesRemaining / 60);
                const remainingText = hoursRemaining > 0 
                    ? `${hoursRemaining} ชั่วโมง ${minutesRemaining % 60} นาที`
                    : `${minutesRemaining} นาที`;
                
                const timeString = new Date(notification.scheduledTime).toLocaleTimeString('th-TH', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const isSoon = minutesRemaining <= 30;
                
                html += `
                    <div class="scheduled-item ${isSoon ? 'soon' : ''}">
                        <div>
                            <strong>${notification.title}</strong>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                ${notification.message}
                            </div>
                            <div style="font-size: 0.8rem; color: #888; margin-top: 5px;">
                                <i class="fas fa-clock"></i> ${timeString} (อีก ${remainingText})
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="cancelNotification('${notification.id}')" 
                                style="padding: 8px 12px; min-width: auto;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Cancel a scheduled notification
        async function cancelNotification(notificationId) {
            const notification = scheduledNotifications.find(n => n.id === notificationId);
            
            if (!notification) return;
            
            if (confirm(`ยกเลิกการแจ้งเตือน "${notification.title}" ใช่หรือไม่?`)) {
                // Update status
                notification.status = 'cancelled';
                
                // Remove from array
                scheduledNotifications = scheduledNotifications.filter(n => n.id !== notificationId);
                
                // Update storage
                await updateScheduledNotification(notification);
                
                // Update UI
                updateScheduledNotificationsUI();
                updateStatistics();
                
                showToast('ยกเลิกการแจ้งเตือนแล้ว', 'info');
                logMessage(`ยกเลิกการแจ้งเตือน: "${notification.title}"`, 'warning');
            }
        }
        
        // Clear all notifications
        async function clearAllNotifications() {
            if (scheduledNotifications.length === 0) {
                showToast('ไม่มีการแจ้งเตือนที่ตั้งเวลาไว้', 'info');
                return;
            }
            
            if (confirm(`ยกเลิกการแจ้งเตือนทั้งหมด ${scheduledNotifications.length} รายการใช่หรือไม่?`)) {
                // Cancel all
                for (const notification of scheduledNotifications) {
                    notification.status = 'cancelled';
                    await updateScheduledNotification(notification);
                }
                
                scheduledNotifications = [];
                
                // Update UI
                updateScheduledNotificationsUI();
                updateStatistics();
                
                showToast('ยกเลิกการแจ้งเตือนทั้งหมดแล้ว', 'success');
                logMessage('ยกเลิกการแจ้งเตือนทั้งหมด', 'warning');
            }
        }
        
        // Start checking for notifications due
        function startNotificationChecker() {
            // Check every 30 seconds
            setInterval(checkScheduledNotifications, 30000);
            
            // Initial check
            setTimeout(checkScheduledNotifications, 1000);
        }
        
        // Check and send due notifications
        function checkScheduledNotifications() {
            const now = Date.now();
            const dueNotifications = scheduledNotifications.filter(n => 
                n.status === 'scheduled' && n.scheduledTime <= now
            );
            
            dueNotifications.forEach(async (notification) => {
                // Send notification
                sendScheduledNotification(notification);
                
                // Update status
                notification.status = 'sent';
                await updateScheduledNotification(notification);
                
                // Log
                logMessage(`ส่งการแจ้งเตือนตามเวลา: "${notification.title}"`, 'success');
            });
            
            // Update UI
            if (dueNotifications.length > 0) {
                updateScheduledNotificationsUI();
                updateStatistics();
            }
        }
        
        // Send a scheduled notification
        function sendScheduledNotification(notification) {
            // Send via service worker if available
            if (serviceWorkerRegistration && serviceWorkerRegistration.active) {
                serviceWorkerRegistration.showNotification(notification.title, {
                    body: notification.message,
                    icon: 'icons/icon-192x192.png',
                    badge: 'icons/icon-96x96.png',
                    tag: notification.id,
                    requireInteraction: true,
                    actions: [
                        {
                            action: 'open',
                            title: 'เปิดแอป'
                        },
                        {
                            action: 'close',
                            title: 'ปิด'
                        }
                    ],
                    data: {
                        url: window.location.href,
                        id: notification.id
                    }
                });
            } 
            // Fallback to regular notification
            else if (Notification.permission === 'granted') {
                new Notification(notification.title, {
                    body: notification.message,
                    icon: 'icons/icon-192x192.png',
                    tag: notification.id
                });
            }
            
            // Play sound
            playNotificationSound();
            
            // Show toast if app is open
            showToast(notification.title, 'info', notification.message);
        }
        
        // Play notification sound
        function playNotificationSound() {
            try {
                const audio = document.getElementById('notificationSound');
                audio.currentTime = 0;
                audio.play().catch(e => console.log('ไม่สามารถเล่นเสียง:', e));
            } catch (error) {
                console.log('ข้อผิดพลาดเล่นเสียง:', error);
            }
        }
        
        // Show toast notification
        function showToast(title, type = 'info', message = '') {
            const container = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
                </div>
                <div class="toast-content">
                    <strong>${title}</strong>
                    ${message ? `<div style="font-size: 0.9rem; margin-top: 5px;">${message}</div>` : ''}
                </div>
                <button class="toast-close">&times;</button>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toast.parentNode) toast.parentNode.removeChild(toast);
                    }, 300);
                }
            }, 5000);
            
            // Close button
            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) toast.parentNode.removeChild(toast);
                }, 300);
            });
        }
        
        // Log message
        function logMessage(message, type = 'info') {
            const container = document.getElementById('notificationLog');
            const now = new Date();
            const timeString = now.toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            logItem.innerHTML = `
                <div>
                    <strong>${message}</strong>
                    <div class="log-time">${timeString}</div>
                </div>
            `;
            
            // Add to top
            container.insertBefore(logItem, container.firstChild);
            
            // Limit to 50 items
            if (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
            
            // Save to storage
            saveLogToStorage(message, type, timeString);
        }
        
        // Clear log
        function clearLog() {
            if (confirm('ล้างบันทึกการทำงานทั้งหมดใช่หรือไม่?')) {
                const container = document.getElementById('notificationLog');
                container.innerHTML = `
                    <div class="log-item">
                        <div>
                            <strong>ล้างบันทึกแล้ว</strong>
                            <div class="log-time">${new Date().toLocaleTimeString('th-TH')}</div>
                        </div>
                    </div>
                `;
                
                localStorage.removeItem('notificationLogs');
                
                showToast('ล้างบันทึกแล้ว', 'info');
            }
        }
        
        // Update statistics
        function updateStatistics() {
            const now = Date.now();
            const scheduled = scheduledNotifications.filter(n => 
                n.status === 'scheduled' && n.scheduledTime > now
            ).length;
            
            const sent = scheduledNotifications.filter(n => 
                n.status === 'sent'
            ).length;
            
            const nextNotification = scheduledNotifications
                .filter(n => n.status === 'scheduled' && n.scheduledTime > now)
                .sort((a, b) => a.scheduledTime - b.scheduledTime)[0];
            
            document.getElementById('scheduledCount').textContent = scheduled;
            document.getElementById('sentCount').textContent = sent;
            
            if (nextNotification) {
                const timeString = new Date(nextNotification.scheduledTime).toLocaleTimeString('th-TH', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                document.getElementById('nextNotification').textContent = timeString;
            } else {
                document.getElementById('nextNotification').textContent = '-';
            }
        }
        
        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const dateString = now.toLocaleDateString('th-TH', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('currentTime').textContent = `${timeString} - ${dateString}`;
        }
        
        // Update system status
        function updateSystemStatus() {
            checkServiceWorkerStatus();
            checkNotificationPermission();
            updateScheduledNotificationsUI();
            updateStatistics();
        }
        
        // Setup PWA install prompt
        function setupInstallPrompt() {
            // Check if app is already installed
            if (window.matchMedia('(display-mode: standalone)').matches) {
                isAppInstalled = true;
                hideInstallBanner();
            }
            
            // Listen for beforeinstallprompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallBanner();
            });
        }
        
        // Show install banner
        function showInstallBanner() {
            if (!isAppInstalled && deferredPrompt) {
                const banner = document.getElementById('installBanner');
                banner.classList.add('show');
            }
        }
        
        // Hide install banner
        function hideInstallBanner() {
            const banner = document.getElementById('installBanner');
            banner.classList.remove('show');
        }
        
        // Install PWA
        async function installPWA() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                logMessage('ผู้ใช้ติดตั้งแอปเป็น PWA', 'success');
            } else {
                logMessage('ผู้ใช้ปฏิเสธการติดตั้งแอป', 'warning');
            }
            
            deferredPrompt = null;
            hideInstallBanner();
        }
        
        // Helper function: Convert base64 to Uint8Array
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            
            const rawData = atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            
            return outputArray;
        }
        
        // Storage Functions
        async function saveScheduledNotification(notification) {
            try {
                // Try IndexedDB first
                if ('indexedDB' in window) {
                    const db = await openDatabase();
                    const tx = db.transaction('notifications', 'readwrite');
                    const store = tx.objectStore('notifications');
                    await store.put(notification);
                    return;
                }
                
                // Fallback to localStorage
                const notifications = JSON.parse(localStorage.getItem('scheduledNotifications') || '[]');
                notifications.push(notification);
                localStorage.setItem('scheduledNotifications', JSON.stringify(notifications));
                
            } catch (error) {
                console.error('Save error:', error);
                // Final fallback to in-memory only
            }
        }
        
        async function loadScheduledNotifications() {
            try {
                let notifications = [];
                
                // Try IndexedDB first
                if ('indexedDB' in window) {
                    const db = await openDatabase();
                    const tx = db.transaction('notifications', 'readonly');
                    const store = tx.objectStore('notifications');
                    const all = await store.getAll();
                    notifications = all || [];
                } 
                // Fallback to localStorage
                else {
                    notifications = JSON.parse(localStorage.getItem('scheduledNotifications') || '[]');
                }
                
                // Filter out cancelled and sent
                const now = Date.now();
                scheduledNotifications = notifications.filter(n => 
                    n.status === 'scheduled' && n.scheduledTime > now
                );
                
                updateScheduledNotificationsUI();
                updateStatistics();
                
                logMessage(`โหลดการแจ้งเตือนที่ตั้งเวลาไว้ ${scheduledNotifications.length} รายการ`, 'info');
                
            } catch (error) {
                console.error('Load error:', error);
                scheduledNotifications = [];
            }
        }
        
        async function updateScheduledNotification(notification) {
            try {
                // Try IndexedDB
                if ('indexedDB' in window) {
                    const db = await openDatabase();
                    const tx = db.transaction('notifications', 'readwrite');
                    const store = tx.objectStore('notifications');
                    await store.put(notification);
                    return;
                }
                
                // Update localStorage
                const notifications = JSON.parse(localStorage.getItem('scheduledNotifications') || '[]');
                const index = notifications.findIndex(n => n.id === notification.id);
                
                if (index !== -1) {
                    notifications[index] = notification;
                    localStorage.setItem('scheduledNotifications', JSON.stringify(notifications));
                }
                
            } catch (error) {
                console.error('Update error:', error);
            }
        }
        
        function saveLogToStorage(message, type, timeString) {
            try {
                const logs = JSON.parse(localStorage.getItem('notificationLogs') || '[]');
                logs.unshift({ message, type, timeString, timestamp: Date.now() });
                
                // Keep only last 100 logs
                if (logs.length > 100) {
                    logs.pop();
                }
                
                localStorage.setItem('notificationLogs', JSON.stringify(logs));
            } catch (error) {
                console.error('Save log error:', error);
            }
        }
        
        // IndexedDB setup
        async function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('NotificationApp', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('notifications')) {
                        const store = db.createObjectStore('notifications', { keyPath: 'id' });
                        store.createIndex('scheduledTime', 'scheduledTime');
                        store.createIndex('status', 'status');
                    }
                };
            });
        }
    </script>
</body>
</html>
