<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô + Google Sheets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        body {
            background-color: #121826;
            color: #e5e7eb;
            font-family: 'Sarabun', sans-serif;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Prompt', sans-serif;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .slide-in {
            animation: slideInRight 0.3s ease-out;
        }
        
        .status-connected { color: #10b981; }
        .status-disconnected { color: #ef4444; }
        .status-connecting { color: #f59e0b; }
        
        /* iOS-like notification badge */
        .notification-badge {
            background-color: #FF3B30;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            top: -5px;
            right: -5px;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Mobile app style */
        @media (max-width: 768px) {
            .container {
                padding-left: 16px;
                padding-right: 16px;
            }
            
            .mobile-hidden {
                display: none !important;
            }
        }
        
        /* App icon for mobile */
        .app-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* New: Broadcast section styling */
        .broadcast-section {
            background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
        }
        
        /* FAB for mobile */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            z-index: 40;
            border: none;
            cursor: pointer;
        }
        
        /* Custom Swal2 styles */
        .swal2-popup {
            font-family: 'Sarabun', sans-serif !important;
            border-radius: 1rem !important;
            background-color: #1f2937 !important;
            color: #e5e7eb !important;
        }
        
        .swal2-title {
            font-family: 'Prompt', sans-serif !important;
            color: #e5e7eb !important;
        }
        
        .swal2-html-container {
            color: #9ca3af !important;
        }
        
        .swal2-confirm {
            background-color: #3b82f6 !important;
        }
        
        .swal2-cancel {
            background-color: #6b7280 !important;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    
    <!-- Floating Action Button for Mobile -->
    <button id="fabNotification" class="fab md:hidden">
        <i class="fas fa-bell"></i>
        <div id="fabBadge" class="notification-badge hidden">0</div>
    </button>
    
    <!-- App Icon for Mobile (PWA) -->
    <div id="appIcon" class="fixed bottom-6 right-6 z-50 app-icon mobile-hidden">
        <i class="fas fa-bell"></i>
        <div id="mobileBadge" class="notification-badge hidden">0</div>
    </div>
    
    <!-- Install Prompt for PWA -->
    <div id="installPrompt" class="hidden fixed bottom-20 right-6 bg-gray-800 rounded-xl p-4 shadow-2xl max-w-xs border border-gray-700 z-50">
        <div class="flex items-center mb-3">
            <div class="app-icon mr-3">
                <i class="fas fa-bell"></i>
            </div>
            <div>
                <h4 class="font-bold text-white">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏õ</h4>
                <p class="text-gray-400 text-sm">‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</p>
            </div>
        </div>
        <div class="flex space-x-2">
            <button id="installBtn" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg text-sm">
                ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
            </button>
            <button id="closeInstallBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">
                ‡∏õ‡∏¥‡∏î
            </button>
        </div>
    </div>
    
    <!-- Mobile Navigation -->
    <div id="mobileNav" class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-800 z-40">
        <div class="flex justify-around p-3">
            <button class="flex flex-col items-center text-gray-400 hover:text-white" onclick="scrollToForm()">
                <i class="fas fa-clock text-xl mb-1"></i>
                <span class="text-xs">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>
            </button>
            <button class="flex flex-col items-center text-gray-400 hover:text-white" onclick="scrollToAlarms()">
                <i class="fas fa-list text-xl mb-1"></i>
                <span class="text-xs">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </button>
            <button id="mobileNotificationBtn" class="flex flex-col items-center text-gray-400 hover:text-white relative">
                <i class="fas fa-bell text-xl mb-1"></i>
                <span class="text-xs">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
                <div id="mobileNavBadge" class="notification-badge hidden">0</div>
            </button>
            <button class="flex flex-col items-center text-gray-400 hover:text-white" onclick="scrollToBroadcast()">
                <i class="fas fa-broadcast-tower text-xl mb-1"></i>
                <span class="text-xs">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</span>
            </button>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-4xl pb-24 md:pb-8">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">
                    <i class="fas fa-bell mr-3"></i>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                </h1>
                <p class="text-gray-400 mt-2">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets</p>
            </div>
            
            <div class="flex items-center space-x-4">
                <!-- Connection Status -->
                <div id="connectionStatus" class="md:flex items-center hidden">
                    <div id="statusDot" class="w-3 h-3 rounded-full bg-green-500 mr-2 pulse"></div>
                    <span id="statusText" class="text-sm status-connected">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets</span>
                </div>
                
                <!-- Notification badge -->
                <div class="relative">
                    <button id="notificationBtn" class="bg-gray-800 hover:bg-gray-700 p-3 rounded-full transition duration-200">
                        <i class="fas fa-bell text-xl"></i>
                        <div id="notificationBadge" class="notification-badge hidden">0</div>
                    </button>
                </div>
            </div>
        </header>

        <!-- Message Display -->
        <div id="msg" class="mb-4 p-4 rounded-lg"></div>

        <!-- Google Sheets Status -->
        <div class="mb-8 bg-green-900 rounded-2xl p-6 shadow-xl border-2 border-green-500">
            <h2 class="text-2xl font-bold text-green-300 mb-4">
                <i class="fas fa-check-circle mr-2"></i>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            </h2>
            <div class="bg-green-800 rounded-lg p-4">
                <p class="text-green-200 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>
                    ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡∏á Google Sheets ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                </p>
                <p class="text-green-300 text-sm">
                    ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                </p>
                <div class="mt-3 flex items-center text-green-400">
                    <i class="fas fa-sync-alt mr-2"></i>
                    <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: <span id="syncCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                </div>
                <div class="mt-2 flex items-center text-green-300">
                    <i class="fas fa-users mr-2"></i>
                    <span>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalUsers">1</span> ‡∏Ñ‡∏ô</span>
                </div>
            </div>
        </div>

        <!-- Broadcast Notification Section -->
        <div id="broadcastSection" class="mb-8 bg-purple-900 rounded-2xl p-6 shadow-xl border-2 border-purple-500">
            <h2 class="text-2xl font-bold text-purple-300 mb-4">
                <i class="fas fa-broadcast-tower mr-2"></i>‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
            </h2>
            <div class="bg-purple-800 rounded-lg p-4">
                <p class="text-purple-200 mb-4">
                    <i class="fas fa-info-circle mr-2"></i>
                    ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)
                </p>
                <div class="mb-4">
                    <label class="block text-purple-200 mb-2" for="broadcastTitle">
                        <i class="fas fa-heading mr-2"></i>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
                    </label>
                    <input 
                        type="text" 
                        id="broadcastTitle" 
                        class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏î‡πà‡∏ß‡∏ô, ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß"
                        maxlength="50"
                    >
                </div>
                <div class="mb-4">
                    <label class="block text-purple-200 mb-2" for="broadcastMessage">
                        <i class="fas fa-comment-alt mr-2"></i>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
                    </label>
                    <textarea 
                        id="broadcastMessage" 
                        rows="3"
                        class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô"
                        maxlength="200"
                    ></textarea>
                </div>
                <div class="flex space-x-3">
                    <button id="sendBroadcastBtn" class="flex-1 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition duration-200">
                        <i class="fas fa-paper-plane mr-2"></i>‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏õ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
                    </button>
                    <button id="testBroadcastBtn" class="px-4 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition duration-200">
                        <i class="fas fa-bell mr-2"></i>‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left column: Form for setting alarms -->
            <div class="lg:col-span-2 bg-gray-900 rounded-2xl p-6 shadow-xl">
                <h2 class="text-2xl font-bold text-blue-300 mb-6">
                    <i class="fas fa-clock mr-2"></i>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                </h2>
                
                <form id="alarmForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Date picker -->
                        <div>
                            <label class="block text-gray-300 mb-2" for="date">
                                <i class="fas fa-calendar-alt mr-2"></i>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                            </label>
                            <input 
                                type="date" 
                                id="date" 
                                class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                min="" 
                                required
                            >
                        </div>
                        
                        <!-- Time picker -->
                        <div>
                            <label class="block text-gray-300 mb-2" for="time">
                                <i class="fas fa-clock mr-2"></i>‡πÄ‡∏ß‡∏•‡∏≤
                            </label>
                            <input 
                                type="time" 
                                id="time" 
                                class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                required
                            >
                        </div>
                    </div>
                    
                    <!-- Title input -->
                    <div>
                        <label class="block text-gray-300 mb-2" for="title">
                            <i class="fas fa-heading mr-2"></i>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                        </label>
                        <input 
                            type="text" 
                            id="title" 
                            class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏µ‡∏°, ‡∏ô‡∏±‡∏î‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå"
                            maxlength="50"
                            required
                        >
                    </div>
                    
                    <!-- Description input -->
                    <div>
                        <label class="block text-gray-300 mb-2" for="description">
                            <i class="fas fa-file-alt mr-2"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </label>
                        <textarea 
                            id="description" 
                            rows="3"
                            class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô"
                            maxlength="200"
                        ></textarea>
                    </div>
                    
                    <!-- Repeat options -->
                    <div>
                        <label class="block text-gray-300 mb-2">
                            <i class="fas fa-redo mr-2"></i>‡∏ó‡∏≥‡∏ã‡πâ‡∏≥
                        </label>
                        <div class="flex flex-wrap gap-3">
                            <label class="inline-flex items-center">
                                <input type="radio" name="repeat" value="none" class="mr-2" checked>
                                <span>‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏ã‡πâ‡∏≥</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="repeat" value="daily" class="mr-2">
                                <span>‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="repeat" value="weekly" class="mr-2">
                                <span>‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="repeat" value="monthly" class="mr-2">
                                <span>‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Action buttons -->
                    <div class="flex justify-between pt-4">
                        <button type="button" id="clearBtn" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition duration-200">
                            <i class="fas fa-trash mr-2"></i>‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
                        </button>
                        <button type="submit" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition duration-200 flex items-center">
                            <i class="fas fa-plus-circle mr-2"></i>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                        </button>
                    </div>
                </form>
                
                <!-- Current time display -->
                <div class="mt-8 pt-6 border-t border-gray-700">
                    <div class="flex items-center justify-center">
                        <div class="text-center">
                            <p class="text-gray-400 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                            <div id="currentTime" class="text-3xl font-bold text-green-400"></div>
                            <div id="currentDate" class="text-gray-400 mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right column: List of active alarms -->
            <div id="alarmsSection" class="bg-gray-900 rounded-2xl p-6 shadow-xl">
                <h2 class="text-2xl font-bold text-blue-300 mb-6">
                    <i class="fas fa-list mr-2"></i>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
                </h2>
                
                <div id="activeAlarms" class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
                    <!-- Alarms will be displayed here -->
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-clock text-4xl mb-4"></i>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ</p>
                        <p class="text-sm mt-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢</p>
                    </div>
                </div>
                
                <div class="mt-8 pt-6 border-t border-gray-700">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-400">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p id="totalAlarms" class="text-xl font-bold">0</p>
                        </div>
                        <button id="clearAllBtn" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm transition duration-200">
                            ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notification panel -->
        <div id="notificationPanel" class="hidden fixed top-0 right-0 w-full md:w-96 h-full bg-gray-900 shadow-2xl z-50 p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-blue-300">
                    <i class="fas fa-bell mr-2"></i>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                    <span id="panelBadge" class="notification-badge ml-2">0</span>
                </h3>
                <div class="flex items-center space-x-3">
                    <button id="clearAllNotificationsBtn" class="text-sm bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded-lg">
                        ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                    <button id="closeNotificationBtn" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            
            <div id="notificationsList" class="space-y-4">
                <!-- Notifications will be displayed here -->
                <div class="text-center py-10 text-gray-500">
                    <i class="fas fa-bell-slash text-4xl mb-4"></i>
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
                </div>
            </div>
            
            <div class="mt-8 pt-6 border-t border-gray-700">
                <button id="markAllReadBtn" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition duration-200">
                    <i class="fas fa-check-double mr-2"></i>‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
        </div>
        
        <!-- Background service status -->
        <div class="mt-8 bg-gray-900 rounded-xl p-4 flex items-center justify-between">
            <div class="flex items-center">
                <div id="serviceStatus" class="w-3 h-3 rounded-full bg-green-500 mr-3 pulse"></div>
                <div>
                    <p class="font-medium">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</p>
                    <p class="text-sm text-gray-400">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ‚Ä¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‚Ä¢ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á</p>
                </div>
            </div>
            <div class="text-right">
                <p id="nextAlarmTime" class="text-sm text-gray-400">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡πÑ‡∏°‡πà‡∏°‡∏µ</p>
                <p id="unreadCountDisplay" class="text-xs text-blue-400">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô: <span>0</span></p>
            </div>
        </div>
        
        <!-- Demo notification -->
        <div id="demoNotification" class="hidden fixed bottom-4 right-4 max-w-sm bg-gray-800 border-l-4 border-blue-500 rounded-lg shadow-xl p-4 z-40 slide-in">
            <div class="flex justify-between">
                <div class="flex-1">
                    <h4 class="font-bold text-blue-300" id="demoTitle"></h4>
                    <p class="text-gray-300 text-sm mt-1" id="demoDesc"></p>
                    <p class="text-gray-500 text-xs mt-2">
                        <i class="far fa-clock mr-1"></i>
                        <span id="demoTime"></span>
                    </p>
                </div>
                <button class="text-gray-500 hover:text-white ml-4" id="closeDemoBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Service Worker and Application Script -->
    <script>
        // DOM elements
        const alarmForm = document.getElementById('alarmForm');
        const notificationBtn = document.getElementById('notificationBtn');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationPanel = document.getElementById('notificationPanel');
        const closeNotificationBtn = document.getElementById('closeNotificationBtn');
        const activeAlarms = document.getElementById('activeAlarms');
        const notificationsList = document.getElementById('notificationsList');
        const clearBtn = document.getElementById('clearBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const markAllReadBtn = document.getElementById('markAllReadBtn');
        const demoNotification = document.getElementById('demoNotification');
        const closeDemoBtn = document.getElementById('closeDemoBtn');
        const currentTimeElement = document.getElementById('currentTime');
        const currentDateElement = document.getElementById('currentDate');
        const nextAlarmTimeElement = document.getElementById('nextAlarmTime');
        const totalAlarmsElement = document.getElementById('totalAlarms');
        const msgElement = document.getElementById('msg');
        const syncCountElement = document.getElementById('syncCount');
        const mobileBadge = document.getElementById('mobileBadge');
        const mobileNavBadge = document.getElementById('mobileNavBadge');
        const mobileNotificationBtn = document.getElementById('mobileNotificationBtn');
        const appIcon = document.getElementById('appIcon');
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');
        const closeInstallBtn = document.getElementById('closeInstallBtn');
        const fabNotification = document.getElementById('fabNotification');
        const fabBadge = document.getElementById('fabBadge');
        const panelBadge = document.getElementById('panelBadge');
        const clearAllNotificationsBtn = document.getElementById('clearAllNotificationsBtn');
        const unreadCountDisplay = document.getElementById('unreadCountDisplay');
        const broadcastTitle = document.getElementById('broadcastTitle');
        const broadcastMessage = document.getElementById('broadcastMessage');
        const sendBroadcastBtn = document.getElementById('sendBroadcastBtn');
        const testBroadcastBtn = document.getElementById('testBroadcastBtn');
        const totalUsersElement = document.getElementById('totalUsers');
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwpOYJ_pB6Llu9bd7RJABMd0awxu09oVFPB1cK4zsq3-aBYze5EpSHTSGgO1EcSJ3DwpQ/exec";
        
        // Firebase-like simple database simulation
        const BROADCAST_DB_KEY = 'alarm_broadcast_db';
        const USER_SESSIONS_KEY = 'alarm_user_sessions';
        
        // Set minimum date to today
        const dateInput = document.getElementById('date');
        const today = new Date().toISOString().split('T')[0];
        dateInput.min = today;
        dateInput.value = today;
        
        // Set default time to next hour
        const timeInput = document.getElementById('time');
        const nextHour = new Date();
        nextHour.setHours(nextHour.getHours() + 1);
        timeInput.value = `${nextHour.getHours().toString().padStart(2, '0')}:00`;
        
        // State variables
        let alarms = JSON.parse(localStorage.getItem('alarms')) || [];
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let unreadCount = parseInt(localStorage.getItem('unreadCount')) || 0;
        let isConnected = true;
        let alarmCheckInterval;
        let deferredPrompt;
        let serviceWorkerRegistration;
        let syncCount = 0;
        let userId = localStorage.getItem('userId') || generateUserId();
        let broadcastNotifications = JSON.parse(localStorage.getItem('broadcastNotifications')) || [];
        let broadcastUnreadCount = parseInt(localStorage.getItem('broadcastUnreadCount')) || 0;
        let connectionTested = false;
        
        // Custom SweetAlert2 configuration
        const SwalConfig = {
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#3b82f6',
            cancelButtonColor: '#6b7280',
            reverseButtons: true,
            showClass: {
                popup: 'animate__animated animate__fadeInDown'
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOutUp'
            }
        };
        
        // Initialize the app
        function init() {
            // Generate user ID if not exists
            if (!localStorage.getItem('userId')) {
                localStorage.setItem('userId', userId);
            }
            
            updateCurrentTime();
            updateAllBadges();
            renderAlarms();
            renderNotifications();
            
            // Register user session
            registerUserSession();
            
            // ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å testConnection ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
            // testConnection(); // ‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å
            
            // Check for alarms every second
            alarmCheckInterval = setInterval(checkAlarms, 1000);
            
            // Update current time every second
            setInterval(updateCurrentTime, 1000);
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(() => {
                    Notification.requestPermission();
                }, 2000);
            }
            
            // Register Service Worker for PWA
            registerServiceWorker();
            
            // Setup PWA install prompt
            setupPWAInstall();
            
            // Check for updates every 5 minutes
            setInterval(() => {
                if (navigator.onLine) {
                    syncPendingData();
                    checkForBroadcastMessages();
                }
            }, 300000);
            
            // Show app icon on mobile
            if ('ontouchstart' in window || navigator.maxTouchPoints) {
                appIcon.classList.remove('mobile-hidden');
            }
            
            // Load broadcast messages
            loadBroadcastMessages();
            
            // Update user count
            updateUserCount();
            
            // Setup periodic badge update
            setInterval(updateAllBadges, 30000);
        }
        
        // Generate unique user ID
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Register user session
        function registerUserSession() {
            const userSessions = JSON.parse(localStorage.getItem(USER_SESSIONS_KEY)) || {};
            userSessions[userId] = {
                lastSeen: new Date().toISOString(),
                userAgent: navigator.userAgent,
                platform: navigator.platform
            };
            
            // Clean up old sessions (older than 7 days)
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            Object.keys(userSessions).forEach(key => {
                if (new Date(userSessions[key].lastSeen) < sevenDaysAgo) {
                    delete userSessions[key];
                }
            });
            
            localStorage.setItem(USER_SESSIONS_KEY, JSON.stringify(userSessions));
        }
        
        // Update user count display
        function updateUserCount() {
            const userSessions = JSON.parse(localStorage.getItem(USER_SESSIONS_KEY)) || {};
            const activeUsers = Object.keys(userSessions).length;
            totalUsersElement.textContent = activeUsers;
        }
        
        // Load broadcast messages
        function loadBroadcastMessages() {
            const broadcastDB = JSON.parse(localStorage.getItem(BROADCAST_DB_KEY)) || {
                messages: [],
                lastChecked: new Date().toISOString()
            };
            
            broadcastNotifications = broadcastDB.messages || [];
            
            // Calculate unread broadcast messages
            broadcastUnreadCount = broadcastNotifications.filter(msg => 
                !msg.readBy || !msg.readBy.includes(userId)
            ).length;
            
            localStorage.setItem('broadcastUnreadCount', broadcastUnreadCount);
            
            // Update badges
            updateAllBadges();
        }
        
        // Check for new broadcast messages
        function checkForBroadcastMessages() {
            const broadcastDB = JSON.parse(localStorage.getItem(BROADCAST_DB_KEY)) || {
                messages: [],
                lastChecked: new Date().toISOString()
            };
            
            const newMessages = broadcastDB.messages.filter(msg => 
                new Date(msg.timestamp) > new Date(broadcastDB.lastChecked)
            );
            
            if (newMessages.length > 0) {
                // Add to notifications
                newMessages.forEach(msg => {
                    if (!broadcastNotifications.find(m => m.id === msg.id)) {
                        broadcastNotifications.push(msg);
                    }
                });
                
                // Update broadcast unread count
                broadcastUnreadCount = broadcastNotifications.filter(msg => 
                    !msg.readBy || !msg.readBy.includes(userId)
                ).length;
                
                localStorage.setItem('broadcastUnreadCount', broadcastUnreadCount);
                localStorage.setItem('broadcastNotifications', JSON.stringify(broadcastNotifications));
                
                // Update badges
                updateAllBadges();
                
                // Show notification for new messages
                if (newMessages.length === 1) {
                    showBroadcastNotification(newMessages[0]);
                } else {
                    showMessage(`‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà ${newMessages.length} ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°`, 'info');
                }
            }
            
            // Update last checked time
            broadcastDB.lastChecked = new Date().toISOString();
            localStorage.setItem(BROADCAST_DB_KEY, JSON.stringify(broadcastDB));
        }
        
        // Show broadcast notification
        function showBroadcastNotification(message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`üì¢ ${message.title}`, {
                    body: message.message,
                    icon: 'https://cdn-icons-png.flaticon.com/512/565/565422.png',
                    tag: 'broadcast-notification',
                    requireInteraction: true
                });
            }
            
            // Show in-app notification
            document.getElementById('demoTitle').textContent = `üì¢ ${message.title}`;
            document.getElementById('demoDesc').textContent = message.message;
            document.getElementById('demoTime').textContent = new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
            
            demoNotification.classList.remove('hidden');
            
            setTimeout(() => {
                demoNotification.classList.add('hidden');
            }, 10000);
        }
        
        // Send broadcast message to all users
        async function sendBroadcastToAll(title, message) {
            try {
                // Create broadcast message
                const broadcastMessage = {
                    id: 'broadcast_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    title: title,
                    message: message,
                    sender: userId,
                    timestamp: new Date().toISOString(),
                    readBy: []
                };
                
                // Get existing broadcast database
                const broadcastDB = JSON.parse(localStorage.getItem(BROADCAST_DB_KEY)) || {
                    messages: [],
                    lastUpdated: new Date().toISOString()
                };
                
                // Add new message
                broadcastDB.messages.unshift(broadcastMessage);
                
                // Keep only last 100 messages
                if (broadcastDB.messages.length > 100) {
                    broadcastDB.messages = broadcastDB.messages.slice(0, 100);
                }
                
                broadcastDB.lastUpdated = new Date().toISOString();
                
                // Save to local storage
                localStorage.setItem(BROADCAST_DB_KEY, JSON.stringify(broadcastDB));
                
                // Add to local notifications
                broadcastNotifications.unshift(broadcastMessage);
                localStorage.setItem('broadcastNotifications', JSON.stringify(broadcastNotifications));
                
                // Update broadcast unread count (not read by this user yet)
                broadcastUnreadCount++;
                localStorage.setItem('broadcastUnreadCount', broadcastUnreadCount);
                
                // Update badges
                updateAllBadges();
                
                // Save to Google Sheets for record
                await saveBroadcastToGoogleSheets(title, message);
                
                // Show success message
                showSweetSuccess(`‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® "${title}" ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                
                // Play success sound
                playSuccessSound();
                
                return true;
            } catch (error) {
                console.error('Error sending broadcast:', error);
                showSweetError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏î‡πâ');
                return false;
            }
        }
        
        // Save broadcast to Google Sheets
        async function saveBroadcastToGoogleSheets(title, message) {
            try {
                const payload = {
                    action: 'add',
                    date: new Date().toLocaleDateString('th-TH'),
                    time: new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}),
                    title: `üì¢ ${title}`,
                    description: message,
                    repeat: 'none',
                    status: 'broadcast',
                    triggered_at: new Date().toISOString(),
                    broadcast: true,
                    user_id: userId
                };
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL parameters
                const params = new URLSearchParams();
                for (const key in payload) {
                    params.append(key, payload[key]);
                }
                
                // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö fetch ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á
                const response = await fetch(GOOGLE_SCRIPT_URL + '?' + params.toString(), {
                    method: "GET"
                });
                
                const data = await response.text();
                console.log('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏•‡∏á Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', data);
                
                return true;
            } catch (error) {
                console.error('Error saving broadcast to Google Sheets:', error);
                return false;
            }
        }
        
        // Test broadcast (send to self)
        function testBroadcast(title, message) {
            const testMessage = {
                id: 'test_' + Date.now(),
                title: title || '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
                message: message || '‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
                sender: 'system',
                timestamp: new Date().toISOString(),
                readBy: []
            };
            
            broadcastNotifications.unshift(testMessage);
            localStorage.setItem('broadcastNotifications', JSON.stringify(broadcastNotifications));
            
            broadcastUnreadCount++;
            localStorage.setItem('broadcastUnreadCount', broadcastUnreadCount);
            
            updateAllBadges();
            
            showBroadcastNotification(testMessage);
            showSweetSuccess('‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            playSuccessSound();
        }
        
        // Mark broadcast as read
        function markBroadcastAsRead(messageId) {
            const broadcastDB = JSON.parse(localStorage.getItem(BROADCAST_DB_KEY)) || { messages: [] };
            
            // Find message in database
            const messageIndex = broadcastDB.messages.findIndex(msg => msg.id === messageId);
            if (messageIndex !== -1) {
                if (!broadcastDB.messages[messageIndex].readBy) {
                    broadcastDB.messages[messageIndex].readBy = [];
                }
                if (!broadcastDB.messages[messageIndex].readBy.includes(userId)) {
                    broadcastDB.messages[messageIndex].readBy.push(userId);
                }
            }
            
            // Update local storage
            localStorage.setItem(BROADCAST_DB_KEY, JSON.stringify(broadcastDB));
            
            // Update local notifications
            const localMessageIndex = broadcastNotifications.findIndex(msg => msg.id === messageId);
            if (localMessageIndex !== -1) {
                if (!broadcastNotifications[localMessageIndex].readBy) {
                    broadcastNotifications[localMessageIndex].readBy = [];
                }
                if (!broadcastNotifications[localMessageIndex].readBy.includes(userId)) {
                    broadcastNotifications[localMessageIndex].readBy.push(userId);
                }
            }
            
            // Recalculate unread count
            broadcastUnreadCount = broadcastNotifications.filter(msg => 
                !msg.readBy || !msg.readBy.includes(userId)
            ).length;
            
            localStorage.setItem('broadcastUnreadCount', broadcastUnreadCount);
            localStorage.setItem('broadcastNotifications', JSON.stringify(broadcastNotifications));
            
            // Update badges
            updateAllBadges();
        }
        
        // Register Service Worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    serviceWorkerRegistration = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/'
                    });
                    console.log('Service Worker registered successfully');
                    
                    // Check for updates
                    serviceWorkerRegistration.addEventListener('updatefound', () => {
                        const newWorker = serviceWorkerRegistration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    console.log('New content available; please refresh.');
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            }
        }
        
        // Setup PWA install prompt
        function setupPWAInstall() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install prompt after 5 seconds
                setTimeout(() => {
                    if (deferredPrompt && !isAppInstalled()) {
                        installPrompt.classList.remove('hidden');
                    }
                }, 5000);
            });
            
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    installPrompt.classList.add('hidden');
                }
            });
            
            closeInstallBtn.addEventListener('click', () => {
                installPrompt.classList.add('hidden');
            });
            
            // Check if app is already installed
            window.addEventListener('appinstalled', () => {
                console.log('PWA installed successfully');
                deferredPrompt = null;
                installPrompt.classList.add('hidden');
            });
        }
        
        // Check if app is installed
        function isAppInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone ||
                   document.referrer.includes('android-app://');
        }
        
        // SweetAlert2 Helper Functions
        function showSweetSuccess(message) {
            Swal.fire({
                icon: 'success',
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: message,
                ...SwalConfig
            });
        }
        
        function showSweetError(message) {
            Swal.fire({
                icon: 'error',
                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                text: message,
                ...SwalConfig
            });
        }
        
        function showSweetWarning(message) {
            Swal.fire({
                icon: 'warning',
                title: '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
                text: message,
                ...SwalConfig
            });
        }
        
        function showSweetInfo(message) {
            Swal.fire({
                icon: 'info',
                title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                text: message,
                ...SwalConfig
            });
        }
        
        function showSweetConfirm(title, text, confirmCallback) {
            Swal.fire({
                icon: 'question',
                title: title,
                text: text,
                showCancelButton: true,
                ...SwalConfig
            }).then((result) => {
                if (result.isConfirmed) {
                    confirmCallback();
                }
            });
        }
        
        // Show message function (‡πÄ‡∏î‡∏¥‡∏°)
        function showMessage(message, type = 'success') {
            msgElement.innerHTML = message;
            msgElement.className = type === 'success' ? 
                'bg-green-900 text-green-300' : 
                type === 'warning' ? 'bg-yellow-900 text-yellow-300' :
                type === 'info' ? 'bg-blue-900 text-blue-300' :
                'bg-red-900 text-red-300';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                msgElement.innerHTML = '';
                msgElement.className = '';
            }, 5000);
        }
        
        // Update current time display
        function updateCurrentTime() {
            const now = new Date();
            currentTimeElement.textContent = now.toLocaleTimeString('th-TH');
            currentDateElement.textContent = now.toLocaleDateString('th-TH', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        // Update all badges (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®)
        function updateAllBadges() {
            // Calculate total unread count (personal + broadcast)
            const totalUnread = unreadCount + broadcastUnreadCount;
            
            // Update all badge elements
            const badgeElements = [
                notificationBadge,
                mobileBadge,
                mobileNavBadge,
                fabBadge,
                panelBadge
            ];
            
            badgeElements.forEach(badge => {
                if (badge) {
                    if (totalUnread > 0) {
                        badge.textContent = totalUnread > 99 ? '99+' : totalUnread;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            });
            
            // Update unread count display
            if (unreadCountDisplay) {
                const span = unreadCountDisplay.querySelector('span');
                if (span) {
                    span.textContent = totalUnread;
                }
            }
            
            // Update page title
            if (totalUnread > 0) {
                document.title = `(${totalUnread}) ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô`;
            } else {
                document.title = '‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô';
            }
            
            // Update app badge if supported
            if ('setAppBadge' in navigator) {
                navigator.setAppBadge(totalUnread).catch(console.error);
            }
            
            // Update sync count
            syncCount = alarms.filter(alarm => alarm.synced).length;
            if (syncCountElement) {
                syncCountElement.textContent = syncCount;
            }
        }
        
        // Render active alarms
        function renderAlarms() {
            if (alarms.length === 0) {
                activeAlarms.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-clock text-4xl mb-4"></i>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ</p>
                        <p class="text-sm mt-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢</p>
                    </div>
                `;
                totalAlarmsElement.textContent = '0';
                nextAlarmTimeElement.textContent = '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡πÑ‡∏°‡πà‡∏°‡∏µ';
                return;
            }
            
            alarms.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            activeAlarms.innerHTML = '';
            let nextAlarm = null;
            
            alarms.forEach((alarm, index) => {
                const alarmDate = new Date(alarm.datetime);
                const now = new Date();
                const isPast = alarmDate < now;
                
                if (!nextAlarm && !isPast && !alarm.triggered) {
                    nextAlarm = alarm;
                }
                
                const alarmElement = document.createElement('div');
                alarmElement.className = `bg-gray-800 rounded-xl p-4 border-l-4 ${isPast ? 'border-gray-600' : 'border-blue-500'} ${alarm.triggered ? 'opacity-70' : ''}`;
                alarmElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-bold ${isPast ? 'text-gray-400' : 'text-white'}">${alarm.title}</h3>
                            <p class="text-gray-400 text-sm mt-1">${alarm.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</p>
                            <div class="flex items-center mt-3">
                                <span class="text-xs px-2 py-1 rounded ${isPast ? 'bg-gray-700 text-gray-400' : 'bg-blue-900 text-blue-300'}">
                                    <i class="far fa-clock mr-1"></i>
                                    ${alarmDate.toLocaleDateString('th-TH')} ${alarmDate.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}
                                </span>
                                ${alarm.repeat !== 'none' ? 
                                    `<span class="text-xs px-2 py-1 rounded bg-purple-900 text-purple-300 ml-2">
                                        <i class="fas fa-redo mr-1"></i>${getRepeatText(alarm.repeat)}
                                    </span>` : ''
                                }
                                ${alarm.triggered ? 
                                    `<span class="text-xs px-2 py-1 rounded bg-green-900 text-green-300 ml-2">
                                        <i class="fas fa-check mr-1"></i>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                                    </span>` : ''
                                }
                                ${alarm.synced ? 
                                    `<span class="text-xs px-2 py-1 rounded bg-green-900 text-green-300 ml-2">
                                        <i class="fas fa-cloud mr-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                                    </span>` : ''
                                }
                            </div>
                        </div>
                        <button class="delete-alarm ml-2 text-gray-500 hover:text-red-400" data-index="${index}" data-id="${alarm.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                activeAlarms.appendChild(alarmElement);
            });
            
            if (nextAlarm) {
                const nextAlarmDate = new Date(nextAlarm.datetime);
                nextAlarmTimeElement.textContent = `‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${nextAlarmDate.toLocaleDateString('th-TH')} ${nextAlarmDate.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}`;
            } else {
                nextAlarmTimeElement.textContent = '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡πÑ‡∏°‡πà‡∏°‡∏µ';
            }
            
            totalAlarmsElement.textContent = alarms.length;
            
            document.querySelectorAll('.delete-alarm').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    const alarmId = this.getAttribute('data-id');
                    confirmDeleteAlarm(index, alarmId);
                });
            });
        }
        
        // Get repeat option text
        function getRepeatText(repeatValue) {
            const repeatMap = {
                'none': '‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏ã‡πâ‡∏≥',
                'daily': '‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô',
                'weekly': '‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
                'monthly': '‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'
            };
            return repeatMap[repeatValue] || repeatValue;
        }
        
        // Render notifications (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®)
        function renderNotifications() {
            // Combine personal notifications and broadcast messages
            const allNotifications = [
                ...broadcastNotifications.map(msg => ({
                    id: msg.id,
                    title: `üì¢ ${msg.title}`,
                    description: msg.message,
                    datetime: msg.timestamp,
                    read: msg.readBy && msg.readBy.includes(userId),
                    type: 'broadcast',
                    sender: msg.sender
                })),
                ...notifications.map(notif => ({
                    ...notif,
                    type: 'personal'
                }))
            ];
            
            // Sort by datetime (newest first)
            allNotifications.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            
            if (allNotifications.length === 0) {
                notificationsList.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-bell-slash text-4xl mb-4"></i>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
                    </div>
                `;
                return;
            }
            
            notificationsList.innerHTML = '';
            
            allNotifications.forEach((notification, index) => {
                const notifDate = new Date(notification.datetime);
                const notificationElement = document.createElement('div');
                notificationElement.className = `bg-gray-800 rounded-xl p-4 border-l-4 ${notification.read ? 'border-gray-600' : notification.type === 'broadcast' ? 'border-purple-500' : 'border-yellow-500'}`;
                notificationElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold ${notification.read ? 'text-gray-400' : 'text-white'}">
                                    ${notification.title}
                                    ${notification.type === 'broadcast' ? '<span class="text-xs text-purple-300 ml-2">(‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®)</span>' : ''}
                                </h3>
                                ${!notification.read ? 
                                    `<span class="text-xs px-2 py-1 rounded ${notification.type === 'broadcast' ? 'bg-purple-900 text-purple-300' : 'bg-yellow-900 text-yellow-300'}">
                                        ‡πÉ‡∏´‡∏°‡πà
                                    </span>` : ''
                                }
                            </div>
                            <p class="text-gray-400 text-sm">${notification.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</p>
                            <div class="flex justify-between items-center mt-3">
                                <p class="text-gray-500 text-xs">
                                    <i class="far fa-clock mr-1"></i>
                                    ${notifDate.toLocaleDateString('th-TH')} ${notifDate.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}
                                </p>
                                ${notification.type === 'broadcast' && !notification.read ? 
                                    `<button class="mark-broadcast-read text-xs px-2 py-1 bg-purple-700 hover:bg-purple-600 text-white rounded" data-id="${notification.id}">
                                        ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                                    </button>` : ''
                                }
                            </div>
                        </div>
                        <button class="delete-notification ml-2 text-gray-500 hover:text-red-400" data-index="${index}" data-type="${notification.type}" data-id="${notification.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                notificationsList.appendChild(notificationElement);
            });
            
            // Add event listeners
            document.querySelectorAll('.delete-notification').forEach(button => {
                button.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    const id = this.getAttribute('data-id');
                    
                    if (type === 'broadcast') {
                        confirmDeleteBroadcastNotification(id);
                    } else {
                        const index = parseInt(this.getAttribute('data-index'));
                        confirmDeleteNotification(index);
                    }
                });
            });
            
            document.querySelectorAll('.mark-broadcast-read').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    markBroadcastAsRead(id);
                    renderNotifications();
                    updateAllBadges();
                    showSweetSuccess('‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
                });
            });
        }
        
        // Confirm delete alarm with SweetAlert
        function confirmDeleteAlarm(index, alarmId) {
            const alarm = alarms[index];
            const alarmDate = new Date(alarm.datetime);
            
            Swal.fire({
                icon: 'warning',
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                html: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô<br>
                      <strong>"${alarm.title}"</strong><br>
                      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${alarmDate.toLocaleDateString('th-TH')} ‡πÄ‡∏ß‡∏•‡∏≤ ${alarmDate.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}<br>
                      <small class="text-gray-400">(‡∏à‡∏∞‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google Sheets ‡∏î‡πâ‡∏ß‡∏¢)</small>`,
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                ...SwalConfig
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteAlarm(index, alarmId);
                }
            });
        }
        
        // Delete an alarm (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google Sheets)
        async function deleteAlarm(index, alarmId) {
            const alarm = alarms[index];
            
            // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google Sheets ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ sheet_id
            if (alarm.synced && alarm.sheet_id) {
                try {
                    await deleteFromGoogleSheets(alarmId, alarm.sheet_id);
                } catch (error) {
                    console.error('Error deleting from Google Sheets:', error);
                    showSweetWarning('‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
                }
            }
            
            // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å localStorage
            alarms.splice(index, 1);
            localStorage.setItem('alarms', JSON.stringify(alarms));
            
            renderAlarms();
            showSweetSuccess('‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }
        
        // Confirm delete broadcast notification
        function confirmDeleteBroadcastNotification(id) {
            Swal.fire({
                icon: 'warning',
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
                text: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ?',
                showCancelButton: true,
                ...SwalConfig
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteBroadcastNotification(id);
                }
            });
        }
        
        // Delete broadcast notification
        function deleteBroadcastNotification(id) {
            // Remove from local notifications
            broadcastNotifications = broadcastNotifications.filter(msg => msg.id !== id);
            localStorage.setItem('broadcastNotifications', JSON.stringify(broadcastNotifications));
            
            // Recalculate unread count
            broadcastUnreadCount = broadcastNotifications.filter(msg => 
                !msg.readBy || !msg.readBy.includes(userId)
            ).length;
            
            localStorage.setItem('broadcastUnreadCount', broadcastUnreadCount);
            
            // Update display
            renderNotifications();
            updateAllBadges();
            showSweetSuccess('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }
        
        // Confirm delete notification
        function confirmDeleteNotification(index) {
            Swal.fire({
                icon: 'warning',
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ?',
                showCancelButton: true,
                ...SwalConfig
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteNotification(index);
                }
            });
        }
        
        // Delete a notification
        function deleteNotification(index) {
            const notification = notifications[index];
            if (!notification.read) {
                unreadCount = Math.max(0, unreadCount - 1);
                localStorage.setItem('unreadCount', unreadCount);
                updateAllBadges();
            }
            
            notifications.splice(index, 1);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            renderNotifications();
            showSweetSuccess('‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }
        
        // Check for alarms that need to be triggered
        function checkAlarms() {
            const now = new Date();
            
            alarms.forEach((alarm, index) => {
                const alarmDate = new Date(alarm.datetime);
                
                if (!alarm.triggered && alarmDate <= now) {
                    triggerAlarm(index);
                    
                    if (alarm.repeat !== 'none') {
                        rescheduleRepeatingAlarm(index);
                    }
                }
            });
        }
        
        // Trigger an alarm
        function triggerAlarm(index) {
            const alarm = alarms[index];
            
            alarms[index].triggered = true;
            alarms[index].triggered_at = new Date().toISOString();
            localStorage.setItem('alarms', JSON.stringify(alarms));
            
            const notification = {
                id: Date.now(),
                title: alarm.title,
                description: alarm.description,
                datetime: new Date().toISOString(),
                read: false,
                alarmIndex: index,
                type: 'alarm'
            };
            
            notifications.unshift(notification);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            unreadCount++;
            localStorage.setItem('unreadCount', unreadCount);
            
            updateAllBadges();
            
            showNotification(alarm);
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            saveToGoogleSheets(alarm, 'triggered');
            
            renderAlarms();
            renderNotifications();
            
            playNotificationSound();
        }
        
        // Save data to Google Sheets - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô GET request
        function saveToGoogleSheets(alarmData, status = 'created') {
            try {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (!alarmData.title || !alarmData.date || !alarmData.time) {
                    console.log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets');
                    return false;
                }
                
                const payload = {
                    action: 'add',
                    date: alarmData.date || new Date(alarmData.datetime).toLocaleDateString('th-TH'),
                    time: alarmData.time || new Date(alarmData.datetime).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}),
                    title: alarmData.title,
                    description: alarmData.description || '',
                    repeat: alarmData.repeat || 'none',
                    status: status || 'active',
                    triggered_at: alarmData.triggered_at || '',
                    user_id: userId,
                    alarm_id: alarmData.id || ''
                };
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL parameters
                const params = new URLSearchParams();
                for (const key in payload) {
                    params.append(key, payload[key]);
                }
                
                // ‡πÉ‡∏ä‡πâ GET request ‡πÅ‡∏ó‡∏ô POST ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS
                fetch(GOOGLE_SCRIPT_URL + '?' + params.toString(), {
                    method: "GET"
                })
                .then(res => res.text())
                .then(data => {
                    console.log('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', data);
                    
                    // Mark the alarm as synced
                    const alarmIndex = alarms.findIndex(a => a.id === alarmData.id);
                    if (alarmIndex !== -1) {
                        alarms[alarmIndex].synced = true;
                        alarms[alarmIndex].sheet_id = data; // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Sheets
                        localStorage.setItem('alarms', JSON.stringify(alarms));
                        renderAlarms();
                        updateAllBadges();
                    }
                })
                .catch(error => {
                    console.error('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets:', error);
                });
                
                return true;
            } catch (error) {
                console.error('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets:', error);
                return false;
            }
        }
        
        // Delete from Google Sheets
        async function deleteFromGoogleSheets(alarmId, sheetId = '') {
            try {
                const payload = {
                    action: 'delete',
                    alarm_id: alarmId,
                    sheet_id: sheetId,
                    user_id: userId
                };
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL parameters
                const params = new URLSearchParams();
                for (const key in payload) {
                    params.append(key, payload[key]);
                }
                
                const response = await fetch(GOOGLE_SCRIPT_URL + '?' + params.toString(), {
                    method: "GET"
                });
                
                const data = await response.text();
                console.log('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', data);
                
                return true;
            } catch (error) {
                console.error('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets:', error);
                return false;
            }
        }
        
        // Sync pending data when online
        function syncPendingData() {
            // Sync alarms that are not synced yet
            alarms.forEach(alarm => {
                if (!alarm.synced && alarm.title && alarm.date && alarm.time) {
                    saveToGoogleSheets(alarm, 'created');
                }
            });
        }
        
        // Test connection to Google Apps Script
        function testConnection() {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            if (connectionTested) return;
            
            const params = new URLSearchParams({
                action: 'test',
                test: 'connection'
            });
            
            fetch(GOOGLE_SCRIPT_URL + '?' + params.toString(), {
                method: "GET"
            })
            .then(res => res.text())
            .then(data => {
                isConnected = true;
                connectionTested = true;
                console.log('Connection test successful:', data);
                showSweetSuccess('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            })
            .catch(error => {
                isConnected = false;
                connectionTested = true;
                console.error('Connection test failed:', error);
                showSweetError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡πÑ‡∏î‡πâ');
            });
        }
        
        // Show browser/system notification
        function showNotification(alarm) {
            document.getElementById('demoTitle').textContent = alarm.title;
            document.getElementById('demoDesc').textContent = alarm.description || '‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß!';
            document.getElementById('demoTime').textContent = new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
            
            demoNotification.classList.remove('hidden');
            
            setTimeout(() => {
                demoNotification.classList.add('hidden');
            }, 10000);
            
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(`‚è∞ ${alarm.title}`, {
                    body: alarm.description || '‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß!',
                    icon: 'https://cdn-icons-png.flaticon.com/512/565/565422.png',
                    tag: 'alarm-notification',
                    requireInteraction: true
                });
                
                notification.onclick = function() {
                    window.focus();
                    this.close();
                };
            }
        }
        
        // Play notification sound
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log("Could not play sound:", e);
            }
        }
        
        // Play success sound
        function playSuccessSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 1000;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log("Could not play success sound:", e);
            }
        }
        
        // Reschedule repeating alarm
        function rescheduleRepeatingAlarm(index) {
            const alarm = alarms[index];
            const alarmDate = new Date(alarm.datetime);
            
            switch (alarm.repeat) {
                case 'daily':
                    alarmDate.setDate(alarmDate.getDate() + 1);
                    break;
                case 'weekly':
                    alarmDate.setDate(alarmDate.getDate() + 7);
                    break;
                case 'monthly':
                    alarmDate.setMonth(alarmDate.getMonth() + 1);
                    break;
            }
            
            const newAlarm = {
                id: Date.now(),
                title: alarm.title,
                description: alarm.description,
                date: alarm.date,
                time: alarm.time,
                datetime: alarmDate.toISOString(),
                repeat: alarm.repeat,
                triggered: false,
                synced: false
            };
            
            alarms.push(newAlarm);
            localStorage.setItem('alarms', JSON.stringify(alarms));
            
            alarms[index].triggered = false;
            alarms[index].datetime = alarmDate.toISOString();
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets
            saveToGoogleSheets(newAlarm, 'created');
            
            renderAlarms();
        }
        
        // Form submission handler
        alarmForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const repeat = document.querySelector('input[name="repeat"]:checked').value;
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!title || !date || !time) {
                showSweetError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡πÄ‡∏ß‡∏•‡∏≤)');
                return;
            }
            
            const datetime = new Date(`${date}T${time}`);
            
            const alarm = {
                id: Date.now(),
                title,
                description,
                date,
                time,
                datetime: datetime.toISOString(),
                repeat,
                triggered: false,
                synced: false
            };
            
            alarms.push(alarm);
            localStorage.setItem('alarms', JSON.stringify(alarms));
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets
            saveToGoogleSheets(alarm, 'created');
            
            // Reset form
            alarmForm.reset();
            dateInput.value = today;
            timeInput.value = `${nextHour.getHours().toString().padStart(2, '0')}:00`;
            document.querySelector('input[name="repeat"][value="none"]').checked = true;
            
            renderAlarms();
            showSweetSuccess(`‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô "${title}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
            playSuccessSound();
        });
        
        // Clear form button
        clearBtn.addEventListener('click', function() {
            alarmForm.reset();
            dateInput.value = today;
            timeInput.value = `${nextHour.getHours().toString().padStart(2, '0')}:00`;
            document.querySelector('input[name="repeat"][value="none"]').checked = true;
        });
        
        // Clear all alarms button
        clearAllBtn.addEventListener('click', function() {
            if (alarms.length === 0) {
                showSweetWarning('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ');
                return;
            }
            
            Swal.fire({
                icon: 'warning',
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                html: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong>${alarms.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?<br>
                      <small class="text-gray-400">(‡∏à‡∏∞‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google Sheets ‡∏î‡πâ‡∏ß‡∏¢)</small>`,
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                ...SwalConfig
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google Sheets ‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
                    for (const alarm of alarms) {
                        if (alarm.synced && alarm.sheet_id) {
                            await deleteFromGoogleSheets(alarm.id, alarm.sheet_id);
                        }
                    }
                    
                    alarms = [];
                    localStorage.setItem('alarms', JSON.stringify(alarms));
                    renderAlarms();
                    showSweetSuccess('‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
            });
        });
        
        // Toggle notification panel
        notificationBtn.addEventListener('click', function() {
            notificationPanel.classList.remove('hidden');
            renderNotifications();
        });
        
        // Mobile notification button
        mobileNotificationBtn.addEventListener('click', function() {
            notificationPanel.classList.remove('hidden');
            renderNotifications();
        });
        
        // FAB notification button
        fabNotification.addEventListener('click', function() {
            notificationPanel.classList.remove('hidden');
            renderNotifications();
        });
        
        // App icon click
        appIcon.addEventListener('click', function() {
            const totalUnread = unreadCount + broadcastUnreadCount;
            if (totalUnread > 0) {
                notificationPanel.classList.remove('hidden');
                renderNotifications();
            } else {
                showSweetInfo('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà');
            }
        });
        
        // Close notification panel
        closeNotificationBtn.addEventListener('click', function() {
            notificationPanel.classList.add('hidden');
        });
        
        // Clear all notifications button
        clearAllNotificationsBtn.addEventListener('click', function() {
            Swal.fire({
                icon: 'warning',
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                text: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?',
                showCancelButton: true,
                ...SwalConfig
            }).then((result) => {
                if (result.isConfirmed) {
                    // Clear personal notifications
                    notifications = [];
                    unreadCount = 0;
                    localStorage.setItem('notifications', JSON.stringify(notifications));
                    localStorage.setItem('unreadCount', unreadCount);
                    
                    // Clear broadcast notifications (only for this user)
                    broadcastNotifications.forEach(msg => {
                        if (!msg.readBy) msg.readBy = [];
                        if (!msg.readBy.includes(userId)) {
                            msg.readBy.push(userId);
                        }
                    });
                    
                    broadcastUnreadCount = 0;
                    localStorage.setItem('broadcastNotifications', JSON.stringify(broadcastNotifications));
                    localStorage.setItem('broadcastUnreadCount', broadcastUnreadCount);
                    
                    // Update broadcast database
                    const broadcastDB = JSON.parse(localStorage.getItem(BROADCAST_DB_KEY)) || { messages: [] };
                    broadcastDB.messages.forEach(msg => {
                        if (!msg.readBy) msg.readBy = [];
                        if (!msg.readBy.includes(userId)) {
                            msg.readBy.push(userId);
                        }
                    });
                    localStorage.setItem(BROADCAST_DB_KEY, JSON.stringify(broadcastDB));
                    
                    // Update display
                    renderNotifications();
                    updateAllBadges();
                    showSweetSuccess('‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
            });
        });
        
        // Mark all notifications as read
        markAllReadBtn.addEventListener('click', function() {
            Swal.fire({
                icon: 'info',
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢',
                text: '‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?',
                showCancelButton: true,
                ...SwalConfig
            }).then((result) => {
                if (result.isConfirmed) {
                    // Mark personal notifications as read
                    notifications.forEach(notification => {
                        notification.read = true;
                    });
                    
                    unreadCount = 0;
                    localStorage.setItem('notifications', JSON.stringify(notifications));
                    localStorage.setItem('unreadCount', unreadCount);
                    
                    // Mark broadcast notifications as read
                    broadcastNotifications.forEach(msg => {
                        if (!msg.readBy) msg.readBy = [];
                        if (!msg.readBy.includes(userId)) {
                            msg.readBy.push(userId);
                        }
                    });
                    
                    broadcastUnreadCount = 0;
                    localStorage.setItem('broadcastNotifications', JSON.stringify(broadcastNotifications));
                    localStorage.setItem('broadcastUnreadCount', broadcastUnreadCount);
                    
                    // Update broadcast database
                    const broadcastDB = JSON.parse(localStorage.getItem(BROADCAST_DB_KEY)) || { messages: [] };
                    broadcastDB.messages.forEach(msg => {
                        if (!msg.readBy) msg.readBy = [];
                        if (!msg.readBy.includes(userId)) {
                            msg.readBy.push(userId);
                        }
                    });
                    localStorage.setItem(BROADCAST_DB_KEY, JSON.stringify(broadcastDB));
                    
                    // Update display
                    renderNotifications();
                    updateAllBadges();
                    showSweetSuccess('‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                }
            });
        });
        
        // Send broadcast button
        sendBroadcastBtn.addEventListener('click', async function() {
            const title = broadcastTitle.value.trim();
            const message = broadcastMessage.value.trim();
            
            if (!title || !message) {
                showSweetError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®');
                return;
            }
            
            Swal.fire({
                icon: 'question',
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
                html: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®<br>
                      <strong>"${title}"</strong><br>
                      ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö?`,
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                ...SwalConfig
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await sendBroadcastToAll(title, message);
                    
                    // Clear form
                    broadcastTitle.value = '';
                    broadcastMessage.value = '';
                    
                    // Update notifications panel
                    renderNotifications();
                }
            });
        });
        
        // Test broadcast button
        testBroadcastBtn.addEventListener('click', function() {
            const title = broadcastTitle.value.trim() || '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®';
            const message = broadcastMessage.value.trim() || '‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®';
            
            Swal.fire({
                icon: 'info',
                title: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®',
                html: `‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ó‡∏î‡∏™‡∏≠‡∏ö:<br>
                      <strong>"${title}"</strong><br>
                      ${message}`,
                showCancelButton: true,
                confirmButtonText: '‡∏™‡πà‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                ...SwalConfig
            }).then((result) => {
                if (result.isConfirmed) {
                    testBroadcast(title, message);
                    
                    // Update notifications panel
                    renderNotifications();
                }
            });
        });
        
        // Close demo notification
        closeDemoBtn.addEventListener('click', function() {
            demoNotification.classList.add('hidden');
        });
        
        // Network status monitoring
        window.addEventListener('online', () => {
            showSweetSuccess('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß');
            isConnected = true;
            syncPendingData();
            checkForBroadcastMessages();
        });
        
        window.addEventListener('offline', () => {
            showSweetWarning('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå');
            isConnected = false;
        });
        
        // Helper functions for mobile navigation
        function scrollToForm() {
            document.querySelector('#alarmForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function scrollToAlarms() {
            document.querySelector('#alarmsSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        function scrollToBroadcast() {
            document.querySelector('#broadcastSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Manual connection test button
        function addManualConnectionTest() {
            const statusDiv = document.querySelector('#connectionStatus');
            if (statusDiv) {
                const testBtn = document.createElement('button');
                testBtn.className = 'ml-4 px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm';
                testBtn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                testBtn.onclick = testConnection;
                statusDiv.appendChild(testBtn);
            }
        }
        
        // Initialize the application
        init();
        addManualConnectionTest();
    </script>
</body>
</html>
