<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตั้งเวลาแจ้งเตือน + Google Sheets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #121826;
            color: #e5e7eb;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .slide-in {
            animation: slideInRight 0.3s ease-out;
        }
        
        .status-connected { color: #10b981; }
        .status-disconnected { color: #ef4444; }
        .status-connecting { color: #f59e0b; }
    </style>
</head>
<body class="min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">
                    <i class="fas fa-bell mr-3"></i>ระบบแจ้งเตือน
                </h1>
                <p class="text-gray-400 mt-2">ตั้งเวลาแจ้งเตือนและบันทึกลง Google Sheets</p>
            </div>
            
            <div class="flex items-center space-x-4">
                <!-- Connection Status -->
                <div id="connectionStatus" class="flex items-center">
                    <div id="statusDot" class="w-3 h-3 rounded-full bg-green-500 mr-2 pulse"></div>
                    <span id="statusText" class="text-sm status-connected">เชื่อมต่อกับ Google Sheets แล้ว</span>
                </div>
                
                <!-- Notification badge -->
                <div class="relative">
                    <button id="notificationBtn" class="bg-gray-800 hover:bg-gray-700 p-3 rounded-full transition duration-200">
                        <i class="fas fa-bell text-xl"></i>
                        <span id="notificationBadge" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold hidden">0</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Message Display -->
        <div id="msg" class="mb-4 p-4 rounded-lg"></div>

        <!-- Google Sheets Status -->
        <div class="mb-8 bg-green-900 rounded-2xl p-6 shadow-xl border-2 border-green-500">
            <h2 class="text-2xl font-bold text-green-300 mb-4">
                <i class="fas fa-check-circle mr-2"></i>เชื่อมต่อกับ Google Sheets สำเร็จ
            </h2>
            <div class="bg-green-800 rounded-lg p-4">
                <p class="text-green-200 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>
                    ระบบสามารถบันทึกข้อมูลแจ้งเตือนลง Google Sheets ได้ทันที
                </p>
                <p class="text-green-300 text-sm">
                    เมื่อคุณตั้งเวลาแจ้งเตือน ข้อมูลจะถูกบันทึกลง Google Sheets อัตโนมัติ
                </p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left column: Form for setting alarms -->
            <div class="lg:col-span-2 bg-gray-900 rounded-2xl p-6 shadow-xl">
                <h2 class="text-2xl font-bold text-blue-300 mb-6">
                    <i class="fas fa-clock mr-2"></i>ตั้งเวลาแจ้งเตือน
                </h2>
                
                <form id="alarmForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Date picker -->
                        <div>
                            <label class="block text-gray-300 mb-2" for="date">
                                <i class="fas fa-calendar-alt mr-2"></i>วันที่
                            </label>
                            <input 
                                type="date" 
                                id="date" 
                                class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                min="" 
                                required
                            >
                        </div>
                        
                        <!-- Time picker -->
                        <div>
                            <label class="block text-gray-300 mb-2" for="time">
                                <i class="fas fa-clock mr-2"></i>เวลา
                            </label>
                            <input 
                                type="time" 
                                id="time" 
                                class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                required
                            >
                        </div>
                    </div>
                    
                    <!-- Title input -->
                    <div>
                        <label class="block text-gray-300 mb-2" for="title">
                            <i class="fas fa-heading mr-2"></i>หัวข้อแจ้งเตือน
                        </label>
                        <input 
                            type="text" 
                            id="title" 
                            class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="เช่น ประชุมทีม, นัดพบแพทย์"
                            maxlength="50"
                            required
                        >
                    </div>
                    
                    <!-- Description input -->
                    <div>
                        <label class="block text-gray-300 mb-2" for="description">
                            <i class="fas fa-file-alt mr-2"></i>รายละเอียด
                        </label>
                        <textarea 
                            id="description" 
                            rows="3"
                            class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="รายละเอียดการแจ้งเตือน"
                            maxlength="200"
                        ></textarea>
                    </div>
                    
                    <!-- Repeat options -->
                    <div>
                        <label class="block text-gray-300 mb-2">
                            <i class="fas fa-redo mr-2"></i>ทำซ้ำ
                        </label>
                        <div class="flex flex-wrap gap-3">
                            <label class="inline-flex items-center">
                                <input type="radio" name="repeat" value="none" class="mr-2" checked>
                                <span>ไม่ทำซ้ำ</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="repeat" value="daily" class="mr-2">
                                <span>ทุกวัน</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="repeat" value="weekly" class="mr-2">
                                <span>ทุกสัปดาห์</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="repeat" value="monthly" class="mr-2">
                                <span>ทุกเดือน</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Action buttons -->
                    <div class="flex justify-between pt-4">
                        <button type="button" id="clearBtn" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition duration-200">
                            <i class="fas fa-trash mr-2"></i>ล้างค่า
                        </button>
                        <button type="submit" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition duration-200 flex items-center">
                            <i class="fas fa-plus-circle mr-2"></i>ตั้งเวลาแจ้งเตือน
                        </button>
                    </div>
                </form>
                
                <!-- Current time display -->
                <div class="mt-8 pt-6 border-t border-gray-700">
                    <div class="flex items-center justify-center">
                        <div class="text-center">
                            <p class="text-gray-400 mb-2">เวลาปัจจุบัน</p>
                            <div id="currentTime" class="text-3xl font-bold text-green-400"></div>
                            <div id="currentDate" class="text-gray-400 mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right column: List of active alarms -->
            <div class="bg-gray-900 rounded-2xl p-6 shadow-xl">
                <h2 class="text-2xl font-bold text-blue-300 mb-6">
                    <i class="fas fa-list mr-2"></i>การแจ้งเตือนที่ตั้งไว้
                </h2>
                
                <div id="activeAlarms" class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
                    <!-- Alarms will be displayed here -->
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-clock text-4xl mb-4"></i>
                        <p>ยังไม่มีเวลาที่ตั้งไว้</p>
                        <p class="text-sm mt-2">เพิ่มการแจ้งเตือนใหม่โดยใช้แบบฟอร์มด้านซ้าย</p>
                    </div>
                </div>
                
                <div class="mt-8 pt-6 border-t border-gray-700">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-400">การแจ้งเตือนทั้งหมด</p>
                            <p id="totalAlarms" class="text-xl font-bold">0</p>
                        </div>
                        <button id="clearAllBtn" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm transition duration-200">
                            ล้างทั้งหมด
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notification panel -->
        <div id="notificationPanel" class="hidden fixed top-0 right-0 w-full md:w-96 h-full bg-gray-900 shadow-2xl z-50 p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-blue-300">
                    <i class="fas fa-bell mr-2"></i>การแจ้งเตือน
                </h3>
                <button id="closeNotificationBtn" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div id="notificationsList" class="space-y-4">
                <!-- Notifications will be displayed here -->
                <div class="text-center py-10 text-gray-500">
                    <i class="fas fa-bell-slash text-4xl mb-4"></i>
                    <p>ยังไม่มีการแจ้งเตือน</p>
                </div>
            </div>
            
            <div class="mt-8 pt-6 border-t border-gray-700">
                <button id="markAllReadBtn" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition duration-200">
                    <i class="fas fa-check-double mr-2"></i>ทำเครื่องหมายว่าอ่านแล้วทั้งหมด
                </button>
            </div>
        </div>
        
        <!-- Background service status -->
        <div class="mt-8 bg-gray-900 rounded-xl p-4 flex items-center justify-between">
            <div class="flex items-center">
                <div id="serviceStatus" class="w-3 h-3 rounded-full bg-green-500 mr-3 pulse"></div>
                <div>
                    <p class="font-medium">บริการแจ้งเตือนทำงานอยู่</p>
                    <p class="text-sm text-gray-400">บันทึกลง Google Sheets เมื่อแจ้งเตือน</p>
                </div>
            </div>
            <div class="text-right">
                <p id="nextAlarmTime" class="text-sm text-gray-400">การแจ้งเตือนถัดไป: ไม่มี</p>
            </div>
        </div>
        
        <!-- Demo notification -->
        <div id="demoNotification" class="hidden fixed bottom-4 right-4 max-w-sm bg-gray-800 border-l-4 border-blue-500 rounded-lg shadow-xl p-4 z-40 slide-in">
            <div class="flex justify-between">
                <div class="flex-1">
                    <h4 class="font-bold text-blue-300" id="demoTitle"></h4>
                    <p class="text-gray-300 text-sm mt-1" id="demoDesc"></p>
                    <p class="text-gray-500 text-xs mt-2">
                        <i class="far fa-clock mr-1"></i>
                        <span id="demoTime"></span>
                    </p>
                </div>
                <button class="text-gray-500 hover:text-white ml-4" id="closeDemoBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const alarmForm = document.getElementById('alarmForm');
        const notificationBtn = document.getElementById('notificationBtn');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationPanel = document.getElementById('notificationPanel');
        const closeNotificationBtn = document.getElementById('closeNotificationBtn');
        const activeAlarms = document.getElementById('activeAlarms');
        const notificationsList = document.getElementById('notificationsList');
        const clearBtn = document.getElementById('clearBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const markAllReadBtn = document.getElementById('markAllReadBtn');
        const demoNotification = document.getElementById('demoNotification');
        const closeDemoBtn = document.getElementById('closeDemoBtn');
        const currentTimeElement = document.getElementById('currentTime');
        const currentDateElement = document.getElementById('currentDate');
        const nextAlarmTimeElement = document.getElementById('nextAlarmTime');
        const totalAlarmsElement = document.getElementById('totalAlarms');
        const msgElement = document.getElementById('msg');
        
        // ตั้งค่า Google Apps Script URL ของคุณตรงนี้
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";
        
        // Set minimum date to today
        const dateInput = document.getElementById('date');
        const today = new Date().toISOString().split('T')[0];
        dateInput.min = today;
        dateInput.value = today;
        
        // Set default time to next hour
        const timeInput = document.getElementById('time');
        const nextHour = new Date();
        nextHour.setHours(nextHour.getHours() + 1);
        timeInput.value = `${nextHour.getHours().toString().padStart(2, '0')}:00`;
        
        // State variables
        let alarms = JSON.parse(localStorage.getItem('alarms')) || [];
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let unreadCount = parseInt(localStorage.getItem('unreadCount')) || 0;
        let isConnected = true; // ตั้งค่าเป็น true เพราะเรามี URL อยู่แล้ว
        let alarmCheckInterval;
        
        // Initialize the app
        function init() {
            updateCurrentTime();
            updateBadge();
            renderAlarms();
            renderNotifications();
            
            // อัตโนมัติเชื่อมต่อกับ Google Sheets
            setTimeout(() => {
                testConnection();
            }, 1000);
            
            // Check for alarms every second
            alarmCheckInterval = setInterval(checkAlarms, 1000);
            
            // Update current time every second
            setInterval(updateCurrentTime, 1000);
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(() => {
                    Notification.requestPermission();
                }, 2000);
            }
        }
        
        // Show message function
        function showMessage(message, type = 'success') {
            msgElement.innerHTML = message;
            msgElement.className = type === 'success' ? 
                'bg-green-900 text-green-300' : 'bg-red-900 text-red-300';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                msgElement.innerHTML = '';
                msgElement.className = '';
            }, 5000);
        }
        
        // Update current time display
        function updateCurrentTime() {
            const now = new Date();
            currentTimeElement.textContent = now.toLocaleTimeString('th-TH');
            currentDateElement.textContent = now.toLocaleDateString('th-TH', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        // Update notification badge
        function updateBadge() {
            if (unreadCount > 0) {
                notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                notificationBadge.classList.remove('hidden');
                notificationBadge.classList.add('pulse');
            } else {
                notificationBadge.classList.add('hidden');
                notificationBadge.classList.remove('pulse');
            }
            
            localStorage.setItem('unreadCount', unreadCount);
        }
        
        // Render active alarms
        function renderAlarms() {
            if (alarms.length === 0) {
                activeAlarms.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-clock text-4xl mb-4"></i>
                        <p>ยังไม่มีเวลาที่ตั้งไว้</p>
                        <p class="text-sm mt-2">เพิ่มการแจ้งเตือนใหม่โดยใช้แบบฟอร์มด้านซ้าย</p>
                    </div>
                `;
                totalAlarmsElement.textContent = '0';
                nextAlarmTimeElement.textContent = 'การแจ้งเตือนถัดไป: ไม่มี';
                return;
            }
            
            alarms.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            activeAlarms.innerHTML = '';
            let nextAlarm = null;
            
            alarms.forEach((alarm, index) => {
                const alarmDate = new Date(alarm.datetime);
                const now = new Date();
                const isPast = alarmDate < now;
                
                if (!nextAlarm && !isPast && !alarm.triggered) {
                    nextAlarm = alarm;
                }
                
                const alarmElement = document.createElement('div');
                alarmElement.className = `bg-gray-800 rounded-xl p-4 border-l-4 ${isPast ? 'border-gray-600' : 'border-blue-500'} ${alarm.triggered ? 'opacity-70' : ''}`;
                alarmElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-bold ${isPast ? 'text-gray-400' : 'text-white'}">${alarm.title}</h3>
                            <p class="text-gray-400 text-sm mt-1">${alarm.description || 'ไม่มีรายละเอียด'}</p>
                            <div class="flex items-center mt-3">
                                <span class="text-xs px-2 py-1 rounded ${isPast ? 'bg-gray-700 text-gray-400' : 'bg-blue-900 text-blue-300'}">
                                    <i class="far fa-clock mr-1"></i>
                                    ${alarmDate.toLocaleDateString('th-TH')} ${alarmDate.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}
                                </span>
                                ${alarm.repeat !== 'none' ? 
                                    `<span class="text-xs px-2 py-1 rounded bg-purple-900 text-purple-300 ml-2">
                                        <i class="fas fa-redo mr-1"></i>${getRepeatText(alarm.repeat)}
                                    </span>` : ''
                                }
                                ${alarm.triggered ? 
                                    `<span class="text-xs px-2 py-1 rounded bg-green-900 text-green-300 ml-2">
                                        <i class="fas fa-check mr-1"></i>แจ้งเตือนแล้ว
                                    </span>` : ''
                                }
                                ${alarm.synced ? 
                                    `<span class="text-xs px-2 py-1 rounded bg-green-900 text-green-300 ml-2">
                                        <i class="fas fa-cloud mr-1"></i>บันทึกแล้ว
                                    </span>` : ''
                                }
                            </div>
                        </div>
                        <button class="delete-alarm ml-2 text-gray-500 hover:text-red-400" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                activeAlarms.appendChild(alarmElement);
            });
            
            if (nextAlarm) {
                const nextAlarmDate = new Date(nextAlarm.datetime);
                nextAlarmTimeElement.textContent = `การแจ้งเตือนถัดไป: ${nextAlarmDate.toLocaleDateString('th-TH')} ${nextAlarmDate.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}`;
            } else {
                nextAlarmTimeElement.textContent = 'การแจ้งเตือนถัดไป: ไม่มี';
            }
            
            totalAlarmsElement.textContent = alarms.length;
            
            document.querySelectorAll('.delete-alarm').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteAlarm(index);
                });
            });
        }
        
        // Get repeat option text
        function getRepeatText(repeatValue) {
            const repeatMap = {
                'none': 'ไม่ทำซ้ำ',
                'daily': 'ทุกวัน',
                'weekly': 'ทุกสัปดาห์',
                'monthly': 'ทุกเดือน'
            };
            return repeatMap[repeatValue] || repeatValue;
        }
        
        // Render notifications
        function renderNotifications() {
            if (notifications.length === 0) {
                notificationsList.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-bell-slash text-4xl mb-4"></i>
                        <p>ยังไม่มีการแจ้งเตือน</p>
                    </div>
                `;
                return;
            }
            
            notifications.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            notificationsList.innerHTML = '';
            
            notifications.forEach((notification, index) => {
                const notifDate = new Date(notification.datetime);
                const notificationElement = document.createElement('div');
                notificationElement.className = `bg-gray-800 rounded-xl p-4 border-l-4 ${notification.read ? 'border-gray-600' : 'border-yellow-500'}`;
                notificationElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold ${notification.read ? 'text-gray-400' : 'text-white'}">${notification.title}</h3>
                                ${!notification.read ? 
                                    `<span class="text-xs px-2 py-1 rounded bg-yellow-900 text-yellow-300">
                                        ใหม่
                                    </span>` : ''
                                }
                            </div>
                            <p class="text-gray-400 text-sm">${notification.description || 'ไม่มีรายละเอียด'}</p>
                            <p class="text-gray-500 text-xs mt-3">
                                <i class="far fa-clock mr-1"></i>
                                ${notifDate.toLocaleDateString('th-TH')} ${notifDate.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}
                            </p>
                        </div>
                        <button class="delete-notification ml-2 text-gray-500 hover:text-red-400" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                notificationsList.appendChild(notificationElement);
            });
            
            document.querySelectorAll('.delete-notification').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteNotification(index);
                });
            });
        }
        
        // Check for alarms that need to be triggered
        function checkAlarms() {
            const now = new Date();
            
            alarms.forEach((alarm, index) => {
                const alarmDate = new Date(alarm.datetime);
                
                if (!alarm.triggered && alarmDate <= now) {
                    triggerAlarm(index);
                    
                    if (alarm.repeat !== 'none') {
                        rescheduleRepeatingAlarm(index);
                    }
                }
            });
        }
        
        // Trigger an alarm
        function triggerAlarm(index) {
            const alarm = alarms[index];
            
            alarms[index].triggered = true;
            alarms[index].triggered_at = new Date().toISOString();
            localStorage.setItem('alarms', JSON.stringify(alarms));
            
            const notification = {
                id: Date.now(),
                title: alarm.title,
                description: alarm.description,
                datetime: new Date().toISOString(),
                read: false,
                alarmIndex: index
            };
            
            notifications.unshift(notification);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            unreadCount++;
            updateBadge();
            
            showNotification(alarm);
            
            // บันทึกลง Google Sheets เมื่อแจ้งเตือน
            if (isConnected) {
                saveToGoogleSheets(alarm, 'triggered');
            }
            
            renderAlarms();
            renderNotifications();
            
            playNotificationSound();
        }
        
        // Save data to Google Sheets - ใช้รูปแบบ fetch ตามที่ต้องการ
        function saveToGoogleSheets(alarmData, status = 'created') {
            if (!isConnected) return false;
            
            try {
                const payload = {
                    date: alarmData.date || new Date(alarmData.datetime).toLocaleDateString('th-TH'),
                    time: alarmData.time || new Date(alarmData.datetime).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}),
                    title: alarmData.title,
                    description: alarmData.description || '',
                    repeat: alarmData.repeat || 'none',
                    status: status || 'active',
                    triggered_at: alarmData.triggered_at || ''
                };
                
                // สร้าง FormData object
                const formData = new FormData();
                for (const key in payload) {
                    formData.append(key, payload[key]);
                }
                
                // ใช้รูปแบบ fetch ตามที่ต้องการ
                fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    body: formData
                })
                .then(res => res.text())
                .then(data => {
                    console.log('บันทึกลง Google Sheets สำเร็จ:', data);
                    
                    // แสดงข้อความตอบกลับ
                    showMessage(data, 'success');
                    
                    // Mark the alarm as synced
                    const alarmIndex = alarms.findIndex(a => a.id === alarmData.id);
                    if (alarmIndex !== -1) {
                        alarms[alarmIndex].synced = true;
                        localStorage.setItem('alarms', JSON.stringify(alarms));
                        renderAlarms();
                    }
                })
                .catch(error => {
                    console.error('ข้อผิดพลาดในการบันทึกลง Google Sheets:', error);
                    showMessage('ไม่สามารถบันทึกลง Google Sheets ได้', 'error');
                });
                
                return true;
            } catch (error) {
                console.error('ข้อผิดพลาดในการบันทึกลง Google Sheets:', error);
                showMessage('ข้อผิดพลาด: ' + error.toString(), 'error');
                return false;
            }
        }
        
        // Test connection to Google Apps Script
        function testConnection() {
            // สร้าง FormData สำหรับการทดสอบ
            const formData = new FormData();
            formData.append('test', 'connection');
            formData.append('action', 'test');
            
            // ใช้รูปแบบ fetch ตามที่ต้องการ
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                body: formData
            })
            .then(res => res.text())
            .then(data => {
                isConnected = true;
                showMessage('เชื่อมต่อสำเร็จกับ Google Sheets: ' + data, 'success');
                
                // Sync existing alarms
                syncExistingAlarms();
            })
            .catch(error => {
                isConnected = false;
                showMessage('ไม่สามารถเชื่อมต่อกับ Google Sheets ได้', 'error');
            });
        }
        
        // Sync existing alarms to Google Sheets
        function syncExistingAlarms() {
            if (!isConnected) return;
            
            const unsyncedAlarms = alarms.filter(alarm => !alarm.synced);
            
            unsyncedAlarms.forEach((alarm, index) => {
                setTimeout(() => {
                    saveToGoogleSheets(alarm, 'synced');
                }, index * 500); // Delay to avoid rate limiting
            });
        }
        
        // Show browser/system notification
        function showNotification(alarm) {
            document.getElementById('demoTitle').textContent = alarm.title;
            document.getElementById('demoDesc').textContent = alarm.description || 'เวลาแจ้งเตือนถึงแล้ว!';
            document.getElementById('demoTime').textContent = new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
            
            demoNotification.classList.remove('hidden');
            
            setTimeout(() => {
                demoNotification.classList.add('hidden');
            }, 10000);
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`⏰ ${alarm.title}`, {
                    body: alarm.description || 'เวลาแจ้งเตือนถึงแล้ว!',
                    icon: 'https://cdn-icons-png.flaticon.com/512/565/565422.png',
                    tag: 'alarm-notification'
                });
            }
        }
        
        // Play notification sound
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log("Could not play sound:", e);
            }
        }
        
        // Reschedule repeating alarm
        function rescheduleRepeatingAlarm(index) {
            const alarm = alarms[index];
            const alarmDate = new Date(alarm.datetime);
            
            switch (alarm.repeat) {
                case 'daily':
                    alarmDate.setDate(alarmDate.getDate() + 1);
                    break;
                case 'weekly':
                    alarmDate.setDate(alarmDate.getDate() + 7);
                    break;
                case 'monthly':
                    alarmDate.setMonth(alarmDate.getMonth() + 1);
                    break;
            }
            
            const newAlarm = {
                id: Date.now(),
                title: alarm.title,
                description: alarm.description,
                date: alarm.date,
                time: alarm.time,
                datetime: alarmDate.toISOString(),
                repeat: alarm.repeat,
                triggered: false,
                synced: false
            };
            
            alarms.push(newAlarm);
            localStorage.setItem('alarms', JSON.stringify(alarms));
            
            alarms[index].triggered = false;
            alarms[index].datetime = alarmDate.toISOString();
            
            // บันทึกลง Google Sheets
            if (isConnected) {
                saveToGoogleSheets(newAlarm, 'created');
            }
            
            renderAlarms();
        }
        
        // Delete an alarm
        function deleteAlarm(index) {
            if (confirm('คุณแน่ใจว่าต้องการลบการแจ้งเตือนนี้?')) {
                alarms.splice(index, 1);
                localStorage.setItem('alarms', JSON.stringify(alarms));
                renderAlarms();
                showMessage('ลบการแจ้งเตือนเรียบร้อยแล้ว', 'success');
            }
        }
        
        // Delete a notification
        function deleteNotification(index) {
            const notification = notifications[index];
            if (!notification.read) {
                unreadCount = Math.max(0, unreadCount - 1);
                updateBadge();
            }
            
            notifications.splice(index, 1);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            renderNotifications();
        }
        
        // Form submission handler
        alarmForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const repeat = document.querySelector('input[name="repeat"]:checked').value;
            
            const datetime = new Date(`${date}T${time}`);
            
            const alarm = {
                id: Date.now(),
                title,
                description,
                date,
                time,
                datetime: datetime.toISOString(),
                repeat,
                triggered: false,
                synced: false
            };
            
            alarms.push(alarm);
            localStorage.setItem('alarms', JSON.stringify(alarms));
            
            // บันทึกลง Google Sheets
            saveToGoogleSheets(alarm, 'created');
            
            // Reset form
            alarmForm.reset();
            dateInput.value = today;
            timeInput.value = `${nextHour.getHours().toString().padStart(2, '0')}:00`;
            document.querySelector('input[name="repeat"][value="none"]').checked = true;
            
            renderAlarms();
        });
        
        // Clear form button
        clearBtn.addEventListener('click', function() {
            alarmForm.reset();
            dateInput.value = today;
            timeInput.value = `${nextHour.getHours().toString().padStart(2, '0')}:00`;
            document.querySelector('input[name="repeat"][value="none"]').checked = true;
        });
        
        // Clear all alarms button
        clearAllBtn.addEventListener('click', function() {
            if (alarms.length === 0) {
                showMessage('ไม่มีเวลาที่ตั้งไว้', 'error');
                return;
            }
            
            if (confirm(`คุณแน่ใจว่าต้องการลบการแจ้งเตือนทั้งหมด ${alarms.length} รายการ?`)) {
                alarms = [];
                localStorage.setItem('alarms', JSON.stringify(alarms));
                renderAlarms();
                showMessage('ลบการแจ้งเตือนทั้งหมดเรียบร้อยแล้ว', 'success');
            }
        });
        
        // Toggle notification panel
        notificationBtn.addEventListener('click', function() {
            notificationPanel.classList.remove('hidden');
            markAllNotificationsAsRead();
        });
        
        // Close notification panel
        closeNotificationBtn.addEventListener('click', function() {
            notificationPanel.classList.add('hidden');
        });
        
        // Mark all notifications as read
        markAllReadBtn.addEventListener('click', function() {
            markAllNotificationsAsRead();
        });
        
        function markAllNotificationsAsRead() {
            if (unreadCount === 0) return;
            
            notifications.forEach(notification => {
                notification.read = true;
            });
            
            localStorage.setItem('notifications', JSON.stringify(notifications));
            unreadCount = 0;
            updateBadge();
            renderNotifications();
            showMessage('ทำเครื่องหมายว่าอ่านแล้วทั้งหมดเรียบร้อย', 'success');
        }
        
        // Close demo notification
        closeDemoBtn.addEventListener('click', function() {
            demoNotification.classList.add('hidden');
        });
        
        // Initialize the application
        init();
    </script>
</body>
</html>
