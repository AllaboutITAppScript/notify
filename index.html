<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</title>
    <meta name="theme-color" content="#1a1a2e">
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    
    <!-- CSS & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt&family=Sarabun&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ */
        /* ... */
    </style>
</head>
<body>
    <!-- ‡∏™‡πà‡∏ß‡∏ô UI ‡πÄ‡∏î‡∏¥‡∏° -->
    <!-- ... -->
    
    <script>
        // ============================================
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö
        // ============================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwpOYJ_pB6Llu9bd7RJABMd0awxu09oVFPB1cK4zsq3-aBYze5EpSHTSGgO1EcSJ3DwpQ/exec";
        
        // Firebase Config ‡∏à‡∏£‡∏¥‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCM6SKKN4vK-3xDOu3ewiNpyNib1fGGMvo",
            authDomain: "notification-system-8a3b7.firebaseapp.com",
            projectId: "notification-system-8a3b7",
            storageBucket: "notification-system-8a3b7.appspot.com",
            messagingSenderId: "297233353891",
            appId: "1:297233353891:web:33b2feb337cbd76afc0119",
            measurementId: "G-9E0TVB6M8M"
        };
        
        // VAPID Key ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Web Push
        const VAPID_KEY = "BIN2eWq9Yv9kLm3nOPq7Q8Hx6z1a5b4c3d2e1f0g9h8i7j6k5l4m3n2o1p0q9r8s7t6u5v4w3x2y1z0";
        
        let alarms = [];
        let notifications = [];
        let userId = '';
        let deviceId = '';
        let firebaseApp = null;
        let firebaseMessaging = null;
        let fcmToken = '';
        let isOnline = true;
        
        // ============================================
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        // ============================================
        async function initApp() {
            console.log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...');
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            loadUserData();
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏° Firebase
            await initFirebase();
            
            // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Notification
            await requestNotificationPermission();
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏° Service Worker
            await initServiceWorker();
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            loadLocalData();
            
            // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
            await connectToServer();
            
            // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏≠‡∏õ
            showApp();
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
            startTimers();
        }
        
        function loadUserData() {
            userId = localStorage.getItem('userId') || 'user_' + Date.now();
            deviceId = localStorage.getItem('deviceId') || 'device_' + Date.now();
            localStorage.setItem('userId', userId);
            localStorage.setItem('deviceId', deviceId);
        }
        
        async function initFirebase() {
            try {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°
                if (typeof firebase === 'undefined') {
                    console.error('Firebase not loaded');
                    return;
                }
                
                // ‡πÇ‡∏´‡∏•‡∏î Firebase SDK ‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å
                await loadFirebaseSDK();
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase
                firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
                firebaseMessaging = firebase.messaging();
                
                console.log('‚úÖ Firebase initialized');
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase Messaging
                setupFirebaseMessaging();
                
            } catch (error) {
                console.error('Firebase init error:', error);
            }
        }
        
        async function loadFirebaseSDK() {
            // ‡πÇ‡∏´‡∏•‡∏î Firebase SDK ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î
            if (typeof firebase === 'undefined') {
                await new Promise((resolve) => {
                    const script = document.createElement('script');
                    script.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js';
                    script.onload = () => {
                        const script2 = document.createElement('script');
                        script2.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js';
                        script2.onload = resolve;
                        document.head.appendChild(script2);
                    };
                    document.head.appendChild(script);
                });
            }
        }
        
        function setupFirebaseMessaging() {
            if (!firebaseMessaging) return;
            
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
            firebaseMessaging.onMessage((payload) => {
                console.log('FCM Message:', payload);
                showNotification(payload.notification?.title || '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', 
                               payload.notification?.body || '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà',
                               payload.data);
            });
        }
        
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Notification');
                return;
            }
            
            // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ö‡∏ô iOS
            if (isIOS()) {
                await requestIOSPermission();
            } 
            // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ö‡∏ô Android/Desktop
            else {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Notification permission granted');
                    await getFCMToken();
                }
            }
        }
        
        async function requestIOSPermission() {
            // iOS ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡πÄ‡∏®‡∏©
            const result = await Swal.fire({
                title: '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô iOS',
                html: `
                    <div class="text-left">
                        <p class="mb-3">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iOS ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤:</p>
                        <ol class="list-decimal pl-4 mb-3">
                            <li>‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï"</li>
                            <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï" ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</li>
                            <li>‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà <i class="fas fa-share-square"></i> (Share)</li>
                            <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Add to Home Screen"</li>
                        </ol>
                        <p class="text-sm text-gray-400">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô PWA</p>
                    </div>
                `,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: '‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï',
                cancelButtonText: '‡∏Ç‡πâ‡∏≤‡∏°',
                background: '#1f2937',
                color: '#e5e7eb'
            });
            
            if (result.isConfirmed) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    await getFCMToken();
                }
            }
        }
        
        async function getFCMToken() {
            if (!firebaseMessaging) return;
            
            try {
                // ‡∏Ç‡∏≠ Token ‡∏à‡∏≤‡∏Å Firebase
                const token = await firebaseMessaging.getToken({
                    vapidKey: VAPID_KEY
                });
                
                if (token) {
                    fcmToken = token;
                    localStorage.setItem('fcmToken', token);
                    console.log('FCM Token:', token);
                    
                    // ‡∏™‡πà‡∏á Token ‡πÑ‡∏õ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
                    await saveFCMToken(token);
                } else {
                    console.log('No FCM token available');
                }
            } catch (error) {
                console.error('Get FCM token error:', error);
            }
        }
        
        async function saveFCMToken(token) {
            try {
                const payload = {
                    action: 'save_fcm_token',
                    device_id: deviceId,
                    user_id: userId,
                    fcm_token: token,
                    platform: isMobile() ? 'mobile' : 'desktop',
                    timestamp: Date.now()
                };
                
                await callServer(payload);
                console.log('FCM token saved');
            } catch (error) {
                console.error('Save FCM token error:', error);
            }
        }
        
        async function initServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Service Worker
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker registered');
                    
                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firebase
                    if (firebaseMessaging) {
                        firebaseMessaging.useServiceWorker(registration);
                    }
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateAlert();
                            }
                        });
                    });
                    
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            }
        }
        
        function loadLocalData() {
            alarms = JSON.parse(localStorage.getItem('alarms')) || [];
            notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        }
        
        async function connectToServer() {
            try {
                await testConnection();
                await registerDevice();
                await syncData();
            } catch (error) {
                console.error('Connect to server error:', error);
            }
        }
        
        function showApp() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hidden');
        }
        
        function startTimers() {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö alarms ‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setInterval(checkAlarms, 1000);
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setInterval(updateTime, 1000);
            updateTime();
            
            // Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setInterval(syncData, 30000);
        }
        
        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å
        // ============================================
        async function addAlarm() {
            const title = prompt('‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:');
            if (!title) return;
            
            const date = prompt('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            if (!date) return;
            
            const time = prompt('‡πÄ‡∏ß‡∏•‡∏≤ (HH:MM):', '12:00');
            if (!time) return;
            
            const description = prompt('‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô):', '');
            
            const alarm = {
                id: 'alarm_' + Date.now(),
                title: title,
                description: description,
                date: date,
                time: time,
                datetime: new Date(date + 'T' + time).toISOString(),
                created_at: new Date().toISOString(),
                user_id: userId,
                device_id: deviceId,
                triggered: false
            };
            
            alarms.push(alarm);
            localStorage.setItem('alarms', JSON.stringify(alarms));
            
            // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
            await saveAlarmToServer(alarm);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            showAlert('success', '‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            
            // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            testNotification('‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ' + title, `‡πÄ‡∏ß‡∏•‡∏≤ ${time} ‡∏ô. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date}`);
        }
        
        async function saveAlarmToServer(alarm) {
            try {
                const payload = {
                    action: 'add_alarm',
                    alarm_id: alarm.id,
                    user_id: userId,
                    device_id: deviceId,
                    title: alarm.title,
                    description: alarm.description || '',
                    date: alarm.date,
                    time: alarm.time,
                    datetime: alarm.datetime,
                    timestamp: Date.now()
                };
                
                await callServer(payload);
            } catch (error) {
                console.error('Save alarm error:', error);
            }
        }
        
        function checkAlarms() {
            const now = new Date();
            
            alarms.forEach(alarm => {
                if (!alarm.triggered && new Date(alarm.datetime) <= now) {
                    triggerAlarm(alarm);
                }
            });
        }
        
        async function triggerAlarm(alarm) {
            alarm.triggered = true;
            localStorage.setItem('alarms', JSON.stringify(alarms));
            
            // ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            await sendCrossDeviceNotification(
                '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ' + alarm.title,
                alarm.description || '‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß',
                'alarm',
                { alarm_id: alarm.id, urgent: true }
            );
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
            await updateAlarmStatus(alarm.id, 'triggered');
        }
        
        async function sendCrossDeviceNotification(title, message, type, data = {}) {
            // ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
            try {
                const payload = {
                    action: 'send_notification',
                    title: title,
                    message: message,
                    type: type,
                    data: JSON.stringify(data),
                    sender_id: userId,
                    sender_name: 'User',
                    fcm_token: fcmToken,
                    timestamp: Date.now()
                };
                
                await callServer(payload);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢
                showNotification(title, message, data);
                
            } catch (error) {
                console.error('Send notification error:', error);
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏•‡πâ‡∏° ‡πÉ‡∏ä‡πâ Local Notification
                showNotification(title, message, data);
            }
        }
        
        function showNotification(title, message, data = {}) {
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
            if ('Notification' in window && Notification.permission === 'granted') {
                const options = {
                    body: message,
                    icon: '/icons/icon-192x192.png',
                    badge: '/icons/icon-96x96.png',
                    tag: 'notification',
                    requireInteraction: data.urgent || false,
                    data: data
                };
                
                const notification = new Notification(title, options);
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
            
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏õ‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà: Firebase ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô Service Worker
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            addToNotifications(title, message, data);
        }
        
        function addToNotifications(title, message, data) {
            const notification = {
                id: 'notif_' + Date.now(),
                title: title,
                message: message,
                type: data.type || 'notification',
                time: new Date().toISOString(),
                data: data
            };
            
            notifications.unshift(notification);
            if (notifications.length > 50) notifications.pop();
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            updateBadges();
        }
        
        function testNotification(title = '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö', message = '‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô') {
            sendCrossDeviceNotification(title, message, 'test', { test: true });
        }
        
        async function sendBroadcast() {
            const title = prompt('‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®:');
            if (!title) return;
            
            const message = prompt('‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®:');
            if (!message) return;
            
            const urgent = confirm('‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡πà‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
            
            await sendCrossDeviceNotification(
                urgent ? 'üö® ' + title : 'üì¢ ' + title,
                message,
                'broadcast',
                { urgent: urgent }
            );
            
            showAlert('success', '‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
        
        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
        // ============================================
        async function callServer(payload) {
            if (!isOnline) {
                throw new Error('Offline');
            }
            
            const params = new URLSearchParams();
            for (const key in payload) {
                params.append(key, payload[key]);
            }
            
            const url = `${GOOGLE_SCRIPT_URL}?${params.toString()}`;
            const response = await fetch(url, { method: 'GET' });
            
            if (response.ok) {
                return await response.json();
            } else {
                throw new Error('Server error');
            }
        }
        
        async function testConnection() {
            try {
                const result = await callServer({ action: 'test' });
                console.log('Server connection:', result);
                return true;
            } catch (error) {
                console.error('Connection test failed:', error);
                return false;
            }
        }
        
        async function registerDevice() {
            try {
                await callServer({
                    action: 'register_device',
                    device_id: deviceId,
                    user_id: userId,
                    timestamp: Date.now()
                });
            } catch (error) {
                console.error('Register device error:', error);
            }
        }
        
        async function syncData() {
            try {
                // Sync alarms
                const alarmsResult = await callServer({
                    action: 'get_alarms',
                    user_id: userId,
                    last_sync: localStorage.getItem('lastSync') || 0
                });
                
                if (alarmsResult.alarms) {
                    // ‡∏£‡∏ß‡∏° alarms ‡πÉ‡∏´‡∏°‡πà
                    alarmsResult.alarms.forEach(serverAlarm => {
                        if (!alarms.find(a => a.id === serverAlarm.id)) {
                            alarms.push(serverAlarm);
                        }
                    });
                    localStorage.setItem('alarms', JSON.stringify(alarms));
                }
                
                // Sync notifications
                const notificationsResult = await callServer({
                    action: 'get_notifications',
                    user_id: userId,
                    last_sync: localStorage.getItem('lastNotificationSync') || 0
                });
                
                if (notificationsResult.notifications) {
                    notificationsResult.notifications.forEach(serverNotif => {
                        if (!notifications.find(n => n.id === serverNotif.id)) {
                            notifications.unshift(serverNotif);
                            showNotification(serverNotif.title, serverNotif.message, serverNotif.data);
                        }
                    });
                    localStorage.setItem('notifications', JSON.stringify(notifications));
                }
                
                localStorage.setItem('lastSync', Date.now());
                
            } catch (error) {
                console.error('Sync error:', error);
            }
        }
        
        async function updateAlarmStatus(alarmId, status) {
            try {
                await callServer({
                    action: 'update_alarm',
                    alarm_id: alarmId,
                    status: status,
                    timestamp: Date.now()
                });
            } catch (error) {
                console.error('Update alarm error:', error);
            }
        }
        
        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        // ============================================
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        function isIOS() {
            return /iPhone|iPad|iPod/i.test(navigator.userAgent);
        }
        
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleTimeString('th-TH');
            document.getElementById('currentDate').textContent = 
                now.toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        function updateBadges() {
            const badge = document.getElementById('notificationBadge');
            if (notifications.length > 0) {
                badge.textContent = notifications.length > 99 ? '99+' : notifications.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        function showAlert(icon, title) {
            Swal.fire({
                icon: icon,
                title: title,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                background: '#1f2937',
                color: '#e5e7eb'
            });
        }
        
        function showUpdateAlert() {
            Swal.fire({
                title: '‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà',
                text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä',
                cancelButtonText: '‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á',
                background: '#1f2937',
                color: '#e5e7eb'
            }).then((result) => {
                if (result.isConfirmed) {
                    location.reload();
                }
            });
        }
        
        // ============================================
        // Event Listeners
        // ============================================
        document.addEventListener('DOMContentLoaded', initApp);
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
        window.addEventListener('online', () => {
            isOnline = true;
            showAlert('success', '‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
            syncData();
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            showAlert('warning', '‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
        });
        
        // ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ
        document.getElementById('addAlarmBtn').addEventListener('click', addAlarm);
        document.getElementById('sendBroadcastBtn').addEventListener('click', sendBroadcast);
        document.getElementById('testBtn').addEventListener('click', () => {
            testNotification();
        });
        
        console.log('‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    </script>
</body>
</html>
